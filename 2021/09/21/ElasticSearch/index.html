<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"odddog-git.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="我们生活中的数据总体分为两种：  结构化数据：指具有固定格式或有限长度的数据，如数据库，元数据等。  非结构化数据：指不定长或无固定格式的数据，如邮件，word 文档等磁盘上的文件">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="http://odddog-git.github.io/2021/09/21/ElasticSearch/index.html">
<meta property="og:site_name" content="hui&#39;s Blog">
<meta property="og:description" content="我们生活中的数据总体分为两种：  结构化数据：指具有固定格式或有限长度的数据，如数据库，元数据等。  非结构化数据：指不定长或无固定格式的数据，如邮件，word 文档等磁盘上的文件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/21/4JOFHA.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/21/4JX8qH.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/21/4JX6ds.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/21/4Jvhb4.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/21/4Jz2BF.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/22/4tbZ38.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/22/4tbmjg.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/22/4tOhVJ.png">
<meta property="article:published_time" content="2021-09-21T01:11:56.000Z">
<meta property="article:modified_time" content="2021-10-07T04:32:15.456Z">
<meta property="article:author" content="怪狗狗">
<meta property="article:tag" content="lucene">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://z3.ax1x.com/2021/09/21/4JOFHA.png">

<link rel="canonical" href="http://odddog-git.github.io/2021/09/21/ElasticSearch/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ElasticSearch | hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://oddDog-git" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://odddog-git.github.io/2021/09/21/ElasticSearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/jerry.jpg">
      <meta itemprop="name" content="怪狗狗">
      <meta itemprop="description" content="跑得又快，长得又帅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hui's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ElasticSearch
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-21 09:11:56" itemprop="dateCreated datePublished" datetime="2021-09-21T09:11:56+08:00">2021-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-07 12:32:15" itemprop="dateModified" datetime="2021-10-07T12:32:15+08:00">2021-10-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8E/" itemprop="url" rel="index"><span itemprop="name">全文检索引擎</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/09/21/ElasticSearch/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/09/21/ElasticSearch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>我们生活中的数据总体分为两种：</p>
<ul>
<li>结构化数据：指具有固定格式或有限长度的数据，如数据库，元数据等。 </li>
<li>非结构化数据：指不定长或无固定格式的数据，如邮件，word 文档等磁盘上的文件</li>
</ul>
<a id="more"></a>

<p>机构化数据可以使用SQL语句进行查询，非结构化数据可使用 顺序扫描法(Serial Scanning) 与 全文检索(Full-text Search) 经行查询</p>
<p><strong>全文检索(Full-text Search)</strong></p>
<p>建立索引 –&gt;  检索索引</p>
<p>全文检索是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在 文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果 反馈给用户的检索方法。这个过程类似于通过字典的目录查字的过程。</p>
<h1 id="lucene相关概念"><a href="#lucene相关概念" class="headerlink" title="lucene相关概念"></a>lucene相关概念</h1><p>Lucene 能够实现全文检索。Lucene 是 apache 下的一个开放源代码的全文检索引擎工具包。提 供了完整的查询引擎和索引引擎，部分文本分析引擎（英文与德文两种西方语言）。Lucene 的目的是 为软件开发人员提供一个简单易用的工具包，以方便的在目标系统中实现全文检索的功能。</p>
<p><strong>Lucene的特性</strong></p>
<ul>
<li>稳定、索引性能高</li>
<li>高效、准确、高性能的搜索算法</li>
<li>跨平台</li>
</ul>
<p><strong>lucene架构</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4JOFHA"><img src="https://z3.ax1x.com/2021/09/21/4JOFHA.png" alt="4JOFHA.png"></a></p>
<p><strong>索引过程</strong></p>
<p>确定原始内容–&gt;采集文档–&gt;创建文档–&gt;分析文档–&gt;索引文档</p>
<p><strong>搜索过程</strong></p>
<p>用户通过搜索界面–&gt;创建查询–&gt;执行搜索，从索引库搜索–&gt;渲染搜索结果</p>
<p><strong>核心概念</strong></p>
<ul>
<li>Document： 一条记录 经过索引之后，就是以一个Document的形式存储在索引文件中的。用户进行搜索，也是以Document 列表的形式返回。 </li>
<li>Field :<ul>
<li> 一个Document可以包含多个信息域，这些信息域就是通过Field在Document中存储的.</li>
<li>Field有两个属性可选：<strong>存储和索引</strong>。存储属性你可以控制是否对这个Field进行存储；索引 属性你可以控制是否对该Field进行索引。 </li>
</ul>
</li>
<li>Term： Term是搜索的最小单位，它表示文档的一个词语，Term由两部分组成：它表示的词语和这个词语所 出现的Field的名称。</li>
</ul>
<p><strong>倒排索引</strong></p>
<p>倒排索引记录每个词条出现在哪些文档，及在文档中的位置，可以根据词条快速定位到包含这个词条的 文档及出现的位置。</p>
<p>创建倒排索引，分为以下几步：</p>
<p>1）创建文档列表：  lucene首先对原始文档数据进行编号（DocID），形成列表，就是一个文档列表</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4JX8qH"><img src="https://z3.ax1x.com/2021/09/21/4JX8qH.png" alt="4JX8qH.png"></a></p>
<p>2）创建倒排索引列表 ：  对文档中数据进行分词，得到词条（分词后的一个又一个词）。对词条进行编号，以词条创建索引。然 后记录下包含该词条的所有文档编号（及其它信息）。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4JX6ds"><img src="https://z3.ax1x.com/2021/09/21/4JX6ds.png" alt="4JX6ds.png"></a></p>
<p>搜索的过程： 当用户输入任意的词条时，首先对用户输入的数据进行分词，得到用户要搜索的所有词条，然后拿着这 些词条去倒排索引列表中进行匹配。找到这些词条就能找到包含这些词条的所有文档的编号。然后根据 这些编号去文档列表中找到文档.</p>
<h1 id="lucene的使用"><a href="#lucene的使用" class="headerlink" title="lucene的使用"></a>lucene的使用</h1><p>需求 : 生成职位信息索引库，从索引库检索数据</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>前提: 创建数据库es，将sql脚本导入数据库执行。（详情省略）</p>
<p>第一步：创建一个SpringBoot项目 </p>
<p>第二步：导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring boot 父启动器依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--测试依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok工具--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--pojo持久化使用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.persistence<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.persistence-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入Lucene核心包及分词器包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-analyzers-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>第三步：启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hui.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LuceneFirstApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LuceneFirstApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第四步：配置properties文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/es?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 驼峰命名</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>第五步：创建实体类、mapper、service </p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Table(name = &quot;job_info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInfo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String companyAddr;</span><br><span class="line">    <span class="keyword">private</span> String companyInfo;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> String jobAddr;</span><br><span class="line">    <span class="keyword">private</span> String jobInfo;</span><br><span class="line">    <span class="keyword">private</span> Integer salaryMin;</span><br><span class="line">    <span class="keyword">private</span> Integer salaryMax;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobInfoMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">JobInfo</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobInfoService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查询所有</span></span><br><span class="line">    <span class="function">List&lt;JobInfo&gt; <span class="title">getList</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title">JobInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobInfoMapper jobInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;JobInfo&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;JobInfo&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> jobInfoMapper.selectList(wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第六步：测试</p>
<p>省略</p>
<h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><p>实现代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LuceneManager</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 用来获取数据库数据</span></span><br><span class="line">    <span class="keyword">private</span> JobInfoService jobInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建索引</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createIndexWrite</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 设置索引文件所在的位置</span></span><br><span class="line">        Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">&quot;C:\\project\\javaCode\\esCode\\index&quot;</span>));</span><br><span class="line">        <span class="comment">// 设置索引相关配置----版本、分词器</span></span><br><span class="line">        Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer(); <span class="comment">// 标准分词器</span></span><br><span class="line">        IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(Version.LATEST, analyzer);</span><br><span class="line">        <span class="comment">// 1. 创建索引---指定位置、配置</span></span><br><span class="line">        IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</span><br><span class="line">        indexWriter.deleteAll();<span class="comment">// 删除原先索引的数据</span></span><br><span class="line">        <span class="comment">// 2. 数据库获取源信息</span></span><br><span class="line">        List&lt;JobInfo&gt; jobInfoList = jobInfoService.getList();</span><br><span class="line">        <span class="comment">// 3. 遍历源信息，分别创建document对象</span></span><br><span class="line">        <span class="keyword">for</span> (JobInfo jobInfo : jobInfoList) &#123;</span><br><span class="line">            Document document = <span class="keyword">new</span> Document();</span><br><span class="line">            <span class="comment">// 创建Field域</span></span><br><span class="line">            document.add(<span class="keyword">new</span> LongField(<span class="string">&quot;id&quot;</span>, jobInfo.getId(), Field.Store.YES));</span><br><span class="line"></span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;companyName&quot;</span>, jobInfo.getCompanyName(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;companyAddr&quot;</span>, jobInfo.getCompanyAddr(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;companyInfo&quot;</span>, jobInfo.getCompanyInfo(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;jobName&quot;</span>, jobInfo.getJobName(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;jobAddr&quot;</span>, jobInfo.getJobAddr(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> TextField(<span class="string">&quot;jobInfo&quot;</span>, jobInfo.getJobInfo(), Field.Store.YES));</span><br><span class="line"></span><br><span class="line">            document.add(<span class="keyword">new</span> IntField(<span class="string">&quot;salaryMin&quot;</span>, jobInfo.getSalaryMin(), Field.Store.YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> IntField(<span class="string">&quot;salaryMax&quot;</span>, jobInfo.getSalaryMax(), Field.Store.YES));</span><br><span class="line"></span><br><span class="line">            document.add(<span class="keyword">new</span> StoredField(<span class="string">&quot;url&quot;</span>, jobInfo.getUrl()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 索引添加document</span></span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;create index success！！！&quot;</span>);</span><br><span class="line">        <span class="comment">// 5. 关闭资源</span></span><br><span class="line">        indexWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Field详情</strong></p>
<p>Document(文档)是Field(域)的承载体, 一个Document由多个Field组成. Field由名称和值两部分组成, Field的值是要索引的内容, 也是要搜索的内容.</p>
<ul>
<li>是否分词(tokenized)   如: 订单编号, 身份证号, 是一个整体, 分词以后就失去了意义, 故不需要分词.</li>
<li>是否索引(indexed)   如: 商品图片路径, 不会作为查询条件, 不需要建立索引.</li>
<li>是否存储(stored)   如: 商品描述. 内容多格式大, 不需要直接在搜索结果页面展现, 不做存储. 需要的时候可 以从关系数据库取.</li>
</ul>
<p><strong>常用的Field类型</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4Jvhb4"><img src="https://z3.ax1x.com/2021/09/21/4Jvhb4.png" alt="4Jvhb4.png"></a></p>
<h2 id="查询索引"><a href="#查询索引" class="headerlink" title="查询索引"></a>查询索引</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JobInfoService jobInfoService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询索引</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchIndexWrite</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 指定索引文件的存储位置</span></span><br><span class="line">    Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">&quot;C:\\project\\javaCode\\esCode\\index&quot;</span>));</span><br><span class="line">    <span class="comment">// 创建读索引对象,指定位置</span></span><br><span class="line">    IndexReader indexReader = DirectoryReader.open(directory);</span><br><span class="line">    <span class="comment">// 创建查询索引对象,指定读索引对象</span></span><br><span class="line">    IndexSearcher indexSearcher = <span class="keyword">new</span> IndexSearcher(indexReader);</span><br><span class="line">    <span class="comment">// 使用term查询：指定查询的域名和关键字</span></span><br><span class="line">    Query query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">&quot;companyName&quot;</span>, <span class="string">&quot;北&quot;</span>));</span><br><span class="line">    <span class="comment">// 执行查询操作，并获取返回结果</span></span><br><span class="line">    TopDocs topDocs = indexSearcher.search(query, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> totalHits = topDocs.totalHits;  <span class="comment">//查询的总数量</span></span><br><span class="line">    System.out.println(<span class="string">&quot;总条数:&quot;</span> + totalHits);</span><br><span class="line"></span><br><span class="line">    ScoreDoc[] scoreDocs = topDocs.scoreDocs; <span class="comment">//获取命中的文档</span></span><br><span class="line">    <span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</span><br><span class="line">        <span class="comment">// 获取文档的id</span></span><br><span class="line">        <span class="keyword">int</span> docId = scoreDoc.doc;</span><br><span class="line">        <span class="comment">// 根据id查询文档</span></span><br><span class="line">        Document document = indexSearcher.doc(docId);</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;companyName&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;companyAddr&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;companyInfo&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;jobName&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;jobAddr&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;jobInfo&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;salaryMin&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;salaryMax&quot;</span>));</span><br><span class="line">        System.out.println(document.get(<span class="string">&quot;url&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;***********************************&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭资源</span></span><br><span class="line">    indexReader.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="中文分词器的使用"><a href="#中文分词器的使用" class="headerlink" title="中文分词器的使用"></a>中文分词器的使用</h2><p>上面查看结果会发现，如果关键字是”北京”会没有数据，如果关键字是“北”就可以搜索到数据，原因是因为 中文会一个字一个字的分词，显然是不合适的，所以我们需要使用可以合理分词的分词器，其中最有名 的是IKAnalyzer分词器</p>
<p>第一步：导依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--IK中文分词器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.janeluo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ikanalyzer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2012_u6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>第二步 创建索引时使用IKanalyzer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建索引</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createIndexWrite</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 设置索引文件所在的位置</span></span><br><span class="line">    Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">&quot;C:\\project\\javaCode\\esCode\\index&quot;</span>));</span><br><span class="line">    <span class="comment">// 设置索引相关配置----版本、分词器</span></span><br><span class="line">    <span class="comment">// Analyzer analyzer = new StandardAnalyzer(); // 标准分词器</span></span><br><span class="line">    Analyzer analyzer = <span class="keyword">new</span> IKAnalyzer(); <span class="comment">// ik分词器</span></span><br><span class="line">    <span class="comment">// 1. 创建索引---指定位置、配置</span></span><br><span class="line">    IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</span><br><span class="line">    <span class="comment">// 。。。上面有，省略。。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ElasticSearch介绍与安装"><a href="#ElasticSearch介绍与安装" class="headerlink" title="ElasticSearch介绍与安装"></a>ElasticSearch介绍与安装</h1><p>es功能： </p>
<ul>
<li>分布式的搜索引擎：百度、Google、站内搜索 </li>
<li>全文检索：提供模糊搜索等自动度很高的查询方式，并进行相关性排名，高亮等功能 </li>
<li>数据分析引擎（分组聚合）：电商网站—一周内手机销量Top10 </li>
<li>对海量数据进行近乎实时处理：水平扩展，每秒钟可处理海量事件，同时能够自动管理索引和查询在集 群中的分布方式，以实现极其流畅的操作。</li>
</ul>
<p>Elastic有一条完整的产品线：Elasticsearch、Logstash、Kibana等，前面说的三个就是大家常说的ELK 技术栈（开源实时日志分析平台）。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4Jz2BF"><img src="https://z3.ax1x.com/2021/09/21/4Jz2BF.png" alt="4Jz2BF.png"></a></p>
<p>Logstash 的作用就是一个数据收集器，将各种格式各种渠道的数据通过它收集解析之后格式化输出到 Elasticsearch ，最后再由 Kibana 提供的比较友好的 Web 界面进行汇总、分析、搜索</p>
<p>Elasticsearch官网：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/elasticsearch">https://www.elastic.co/cn/products/elasticsearch</a></p>
<p>目前Elasticsearch最新的版本是7.x，企业内目前用的比较多是6.x，这里使用的是6.2.4，需要JDK1.8 及以上。</p>
<h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><p>1）下载好压缩包  elasticsearch-6.2.4.zip  ，并解压</p>
<p>2）修改配置文件</p>
<p>打开 config/elasticsearch.yml 文件,修改33与37行 数据与日志存放的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path.data: c:\data</span><br><span class="line"></span><br><span class="line">path.logs: c:\log</span><br></pre></td></tr></table></figure>
<p>3）进入bin目录中直接双击  elasticsearch.bat 命令</p>
<p>如果启动失败，需要修改虚拟机内存的大小 ，打开config/jvm.options文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br></pre></td></tr></table></figure>
<ul>
<li>Xms 是指设定程序启动时占用内存大小。一般来讲，大点，程序会启动的快一点，但是也可能会 导致机器暂时间变慢。 </li>
<li>Xmx 是指设定程序运行期间最大可占用的内存大小。如果程序运行需要占用更多的内存，超出了 这个设置值，就会抛出OutOfMemory异常。</li>
</ul>
<p><strong>访问</strong></p>
<p>可以看到绑定了两个端口: </p>
<ul>
<li>9300：集群节点间通讯接口，接收tcp协议 </li>
<li>9200：客户端访问接口，接收Http协议 </li>
</ul>
<p>我们在浏览器中访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/">http://127.0.0.1:9200</a></p>
<h2 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h2><p>Kibana是一个基于Node.js的Elasticsearch索引库数据统计工具,提供了操作Elasticsearch索引数据的控制台。</p>
<p><strong>注意</strong>    需安装Node.js</p>
<p>1）下载压缩包，并解压，版本要与es保持一致</p>
<p>2）修改 config/kibana.yml 配置文件,指定es服务器地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch.url: &quot;http:&#x2F;&#x2F;127.0.0.1:9200&quot;</span><br></pre></td></tr></table></figure>
<p>3）进入bin目录，双击kibana.bat 命令</p>
<p>4）访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:5601/">http://127.0.0.1:5601</a></p>
<h2 id="安装Ik分词器"><a href="#安装Ik分词器" class="headerlink" title="安装Ik分词器"></a>安装Ik分词器</h2><p>下载地址  <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>1）解压elasticsearch-analysis-ik-6.2.4.zip后,将解压后的文件夹拷贝到elasticsearch-6.2.4\plugins 下，并重命名文件夹为ik</p>
<p>2）重新启动ElasticSearch，即可加载IK分词器</p>
<p>​    ik分词器 有ik_max_word 与 ik_smart 两种模式</p>
<h2 id="安装Head插件"><a href="#安装Head插件" class="headerlink" title="安装Head插件"></a>安装Head插件</h2><p>elasticsearch-head是一个界面化的集群操作和管理工具，可以对集群进行傻瓜式操作。你可以通过 插件把它集成到es（首选方式）,也可以安装成一个独立webapp。</p>
<p>es-head主要有三个方面的操作： </p>
<ol>
<li>显示集群的拓扑,并且能够执行索引和节点级别操作 </li>
<li>搜索接口能够查询集群中原始json或表格格式的检索数据 </li>
<li>能够快速访问并显示集群的状态</li>
</ol>
<p><strong>elasticsearch-head 安装</strong>（基于谷歌浏览器） </p>
<ol>
<li>直接下载压缩包，地址：<a target="_blank" rel="noopener" href="https://files.cnblogs.com/files/sanduzxcvbnm/elasticsearch-head.7z">https://files.cnblogs.com/files/sanduzxcvbnm/elasticsearch-head.7z</a></li>
<li>解压</li>
<li>在谷歌浏览器扩展程序中点击“加载已解压的压缩程序”，找到elasticsearch-head文件夹，点击打开即可进 行安装。</li>
<li>使用时在谷歌浏览器中直接点击 elasticsearch-head 小图标 </li>
</ol>
<h1 id="kibana的相关操作"><a href="#kibana的相关操作" class="headerlink" title="kibana的相关操作"></a>kibana的相关操作</h1><p><strong>基本概念</strong></p>
<p>1、文档 （document） </p>
<p>存入索引库原始的数据。</p>
<ul>
<li>它可以是层次的。文档中还包含新的文档，字段还可以包含其他字段和取值。\</li>
<li>它拥有灵活的结构。文档不依赖于预先定义的模式。</li>
</ul>
<p>2、类型 （type） </p>
<p>类型是文档的逻辑容器，类似于表格是行的容器。在不同的类型中，最好放入不同结构的文档。 </p>
<p>3、索引 （index） </p>
<p>索引是映射类型的容器。一个Elasticsearch索引是独立的大量的文档集合。 每个索引存储在磁盘上的同 组文件中，索引存储了所有映射类型的字段，还有一些设置。 </p>
<p>4、映射（mapping）</p>
<p>字段的数据类型、属性、是否索引、是否存储等特性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ElasticSearch 与 Mysql 对比</span><br><span class="line">索引库（indices）---------------------------------Database 数据库</span><br><span class="line">类型（type）----------------------------------Table 数据表</span><br><span class="line">文档（Document）---------------------------------Row 行</span><br><span class="line">域字段（Field）--------------------------------Columns 列</span><br><span class="line">映射配置（mappings）-------------------------------每个列的约束（类型、长度）</span><br></pre></td></tr></table></figure>
<h2 id="对索引库操作"><a href="#对索引库操作" class="headerlink" title="对索引库操作"></a>对索引库操作</h2><p>Elasticsearch采用Rest风格API，因此其API就是一次http请求，你可以用任何工具发起http请求</p>
<p>创建索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;hui</span><br></pre></td></tr></table></figure>
<p>配置分片与副本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;lagou</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 5,   # 分片数量，默认5</span><br><span class="line">        &quot;number_of_replicas&quot;: 1  # 副本数量，默认1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui</span><br></pre></td></tr></table></figure>
<p>删除索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE &#x2F;hui</span><br></pre></td></tr></table></figure>
<h2 id="对类型与映射操作"><a href="#对类型与映射操作" class="headerlink" title="对类型与映射操作"></a>对类型与映射操作</h2><p>注意：Elasticsearch7.x取消了索引type类型的设置，不允许指定类型，默认为_doc，但字段仍然是有 的，我们需要设置字段的约束信息，叫做字段映射（mapping）</p>
<p><strong>创建字段映射</strong></p>
<p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;索引库名&#x2F;_mapping&#x2F;类型名</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;字段名&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;类型&quot;,</span><br><span class="line">            &quot;index&quot;: true,  # 是否索引，默认为true</span><br><span class="line">            &quot;store&quot;: false, # 是否额外存储，默认为false</span><br><span class="line">            &quot;analyzer&quot;: &quot;分词器&quot;,</span><br><span class="line">            &quot;boost&quot;: 1.0    # 权重</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：添加 goods 类型 ，设置3个字段：title、images、price</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT hui&#x2F;_mapping&#x2F;goods</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;images&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;false&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;: &#123;</span><br><span class="line">       	 	&quot;type&quot;: &quot;float&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建索引时创建字段映射</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;索引库名</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;:&#123;</span><br><span class="line">    	&quot;索引库属性名&quot;:&quot;索引库属性值&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot;:&#123;</span><br><span class="line">        &quot;类型名&quot;:&#123;</span><br><span class="line">        &quot;properties&quot;:&#123;</span><br><span class="line">                &quot;字段名&quot;:&#123;</span><br><span class="line">                	&quot;映射属性名&quot;:&quot;映射属性值&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;hui2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;&#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;goods&quot;: &#123;</span><br><span class="line">        	&quot;properties&quot;: &#123;</span><br><span class="line">            	&quot;title&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                    &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查看映射</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;索引库名&#x2F;_mapping    		# 查看所有</span><br><span class="line">GET &#x2F;索引库名&#x2F;_mapping&#x2F;类型名    # 查看某个类型</span><br></pre></td></tr></table></figure>
<h3 id="映射属性详解"><a href="#映射属性详解" class="headerlink" title="映射属性详解"></a>映射属性详解</h3><h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><ul>
<li><p>String类型，又分两种</p>
<ul>
<li>text：使用文本数据类型的字段，它们会被分词，文本字段不用于排序，很少用于聚合，如 文章标题、正文。 </li>
<li>keyword：关键字数据类型，用于索引结构化内容的字段，不会被分词，必须完整匹配的内 容，如邮箱，身份证号。支持聚合</li>
</ul>
<p>但有的时候，对于一个字符串字段，我们可能希望他两种都支持，可以利用其多字段特性</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">    &quot;title&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;sort&quot;:&#123;</span><br><span class="line">            	&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;index&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Numerical：数值类型</p>
<p>long、interger、short、byte、double、float、half_float</p>
</li>
<li><p>Date：日期类型</p>
<p>elasticsearch可以对日期格式化为字符串存储，但是建议我们存储为毫秒值，存储为long，节省 空间。</p>
</li>
<li><p>Array：数组类型</p>
<ul>
<li>进行匹配时，任意一个元素满足，都认为满足 </li>
<li>排序时，如果升序则用数组中的最小值来排序，如果降序则用数组中的最大值来排序</li>
</ul>
</li>
<li><p>Object：对象</p>
<ul>
<li>JSON文档本质上是分层的：文档包含内部对象，内部对象本身还包含内部对象。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &#123; </span><br><span class="line">        	&quot;type&quot;: &quot;long&quot; </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;person&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                    &quot;age&quot;: &#123; &quot;type&quot;: &quot;integer&quot; &#125;,</span><br><span class="line">                    &quot;name&quot;: &#123; &quot;type&quot;: &quot;text&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="store"><a href="#store" class="headerlink" title="store"></a>store</h4><p>是否将数据进行额外存储，默认false。</p>
<p>Elasticsearch在创建文档索引时，会将文档中的原始数据保存到 _source 的属性 中。如果 store为true，会在 _source 以外额外存储一份数据。可以将经常使用的数据经行额外保存。</p>
<h4 id="boost"><a href="#boost" class="headerlink" title="boost"></a>boost</h4><p>权重，默认1。新增数据时，可以指定字段的权重，权重越高，得分越高，排名越靠前。</p>
<h2 id="对文档操作"><a href="#对文档操作" class="headerlink" title="对文档操作"></a>对文档操作</h2><p><strong>添加文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;hui&#x2F;goods&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;:&quot;小米手机&quot;,</span><br><span class="line">    &quot;images&quot;:&quot;http:&#x2F;&#x2F;image.lagou.com&#x2F;12479122.jpg&quot;,</span><br><span class="line">    &quot;price&quot;:2699.00</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会随机生成id，不建议，可以指定id，一般将数据库中的id字段成为文档id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;索引库名&#x2F;类型&#x2F;id值    # 指定id添加文档</span><br><span class="line">&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p><strong>查看文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;goods&#x2F;id值</span><br></pre></td></tr></table></figure>
<p><strong>修改文档</strong></p>
<p>PUT：修改文档   POST：新增文档</p>
<p>其实PUT与POST请求都不重要，如果id存在就修改，不存在就新增</p>
<p><strong>删除</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE &#x2F;hui&#x2F;goods&#x2F;id值</span><br></pre></td></tr></table></figure>
<p><strong>智能判断</strong></p>
<p>es可以根据你输入的数据 来判断类型，动态添加数据映射。</p>
<p>例如添加的title字段，String类型数据，ES无法智能判断，它就会存入两个字段。</p>
<p> title：text类型     title.keyword：keyword类型</p>
<p>这种智能映射，底层原理是动态模板映射，如果我们想修改这种智能映射的规则，其实只要修改动态模 板即可！</p>
<p><strong>动态映射模板</strong></p>
<p>示例：创建hui索引时，添加goods类型并设置动态模板，将string类型字段转换成keyword类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT hui</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;goods&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                    &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;dynamic_templates&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;strings&quot;: &#123;     # 模板名称 ，自定义  </span><br><span class="line">                    	&quot;match_mapping_type&quot;: &quot;string&quot;,  # 匹配的类型</span><br><span class="line">                        &quot;mapping&quot;: &#123;     # 映射规则</span><br><span class="line">                            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                            &quot;index&quot;:false,</span><br><span class="line">                            &quot;store&quot;:true</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果向该类型中添加文档时，添加了没指定映射的字段，如果是String类型，会自动转换成keyword类型。</p>
<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h2 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h2><p>基本语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;索引库名&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;查询类型&quot;:&#123;</span><br><span class="line">        	&quot;查询条件&quot;:&quot;查询条件值&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的query代表一个查询对象，里面可以有不同的查询属性 </p>
<ul>
<li><p>查询类型： 例如： match_all ， match ， term ， range 等等 </p>
</li>
<li><p>查询条件：查询条件会根据类型的不同，写法也有差异，后面详细讲解</p>
</li>
</ul>
<h3 id="查询所有-match-all"><a href="#查询所有-match-all" class="headerlink" title="查询所有(match_all)"></a>查询所有(match_all)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">    	&quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="匹配查询-match"><a href="#匹配查询-match" class="headerlink" title="匹配查询(match)"></a>匹配查询(match)</h3><ul>
<li>or关系 </li>
</ul>
<p>match 类型查询，会把查询条件进行分词，然后进行查询,多个词条之间是or的关系。</p>
<p>将小米相关的数据，与电视相关的数据都给查询出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;title&quot;:&quot;小米电视&quot;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>and关系</li>
</ul>
<p>案例中，只有同时包含 小米 和 电视 的词条才会被搜索到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">        	&quot;title&quot;:&#123;&quot;query&quot;:&quot;小米电视&quot;,&quot;operator&quot;:&quot;and&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="词条匹配-term"><a href="#词条匹配-term" class="headerlink" title="词条匹配(term)"></a>词条匹配(term)</h3><p>term 查询被用于精确值 匹配，这些精确值可能是数字、时间、布尔或者那些未分词的字符 串,keyword类型的字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;term&quot;:&#123;</span><br><span class="line">        	&quot;price&quot;:2699.00</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="布尔组合-bool"><a href="#布尔组合-bool" class="headerlink" title="布尔组合(bool)"></a>布尔组合(bool)</h3><p>bool 把各种其它查询通过 must （与）、 must_not （非）、 should （或）的方式进行组合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">    	&quot;bool&quot;:&#123;</span><br><span class="line">            &quot;must&quot;: &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;小米&quot; &#125;&#125;,</span><br><span class="line">            &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;电视&quot; &#125;&#125;,</span><br><span class="line">            &quot;should&quot;: &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;手机&quot; &#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询结果:查询title包含小米，不包含电视，但可以包含手机(前提是title包含小米)</p>
<h3 id="范围查询-range"><a href="#范围查询-range" class="headerlink" title="范围查询(range)"></a>范围查询(range)</h3><p>查询找出那些落在指定区间内的数字或者时间</p>
<p>gt   大于、 gte  大于等于、 lt   小于、 lte   小于等于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &#123;</span><br><span class="line">                &quot;gte&quot;: 1000.0,</span><br><span class="line">                &quot;lt&quot;: 2800.00</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="模糊查询-fuzzy"><a href="#模糊查询-fuzzy" class="headerlink" title="模糊查询(fuzzy)"></a>模糊查询(fuzzy)</h3><p>fuzzy 查询是 term 查询的模糊等价。它允许用户搜索词条与实际词条的拼写出现偏差，但是偏差的 编辑距离不得超过2。（很少使用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot;: &#123;</span><br><span class="line">        	&quot;title&quot;: &quot;appla&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的查询，也能查询到apple手机</p>
<h2 id="结果过滤"><a href="#结果过滤" class="headerlink" title="结果过滤"></a>结果过滤</h2><p>默认情况下，会显示_source的所有字段。 如果我们只想获取其中的部分字段，我们可以添加 _source 的过滤</p>
<h3 id="直接指定字段"><a href="#直接指定字段" class="headerlink" title="直接指定字段"></a>直接指定字段</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: [&quot;title&quot;,&quot;price&quot;],</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="指定includes和excludes"><a href="#指定includes和excludes" class="headerlink" title="指定includes和excludes"></a>指定includes和excludes</h3><p>includes：来指定想要显示的字段</p>
<p>excludes：来指定不想要显示的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">    	&quot;includes&quot;:[&quot;title&quot;,&quot;price&quot;]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="过滤（filter）"><a href="#过滤（filter）" class="headerlink" title="过滤（filter）"></a>过滤（filter）</h2><p>查询与过滤： 通常的规则是，使用查询（query）语句来进行 全文 搜索或者其它任何需要影响 相关性得分 的搜索。 除此以外的情况都使用过滤（filters)。</p>
<p><strong>条件查询中进行过滤</strong></p>
<p>所有的查询都会影响到文档的评分及排名。如果我们需要在查询结果中进行过滤，并且不希望过滤条件 影响评分，那么就不要把过滤条件作为查询条件来用。而是使用 filter 方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;bool&quot;:&#123;</span><br><span class="line">            &quot;must&quot;:&#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;小米手机&quot; &#125;&#125;,</span><br><span class="line">            &quot;filter&quot;:&#123;</span><br><span class="line">            	&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gt&quot;:2000.00,&quot;lt&quot;:3800.00&#125;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>无查询条件，直接过滤</strong></p>
<p>如果一次查询只有过滤，没有查询条件，不希望进行评分，我们可以使用 constant_score 取代只有 filter 语句的 bool 查询。在性能上是完全相同的，但对于提高查询简洁性和清晰度有很大帮助。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;constant_score&quot;: &#123;</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">            	&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gt&quot;:2000.00,&quot;lt&quot;:3000.00&#125;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p>可指定多字段排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;bool&quot;:&#123;</span><br><span class="line">            &quot;must&quot;:&#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;小米手机&quot; &#125;&#125;,</span><br><span class="line">            &quot;filter&quot;:&#123;</span><br><span class="line">            	&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gt&quot;:200000,&quot;lt&quot;:300000&#125;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123; &quot;price&quot;: &#123; &quot;order&quot;: &quot;desc&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;_score&quot;: &#123; &quot;order&quot;: &quot;desc&quot; &#125;&#125; #如果价格一样就对得分排序</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p>from：目标数据的偏移值（开始位置），默认from为0 </p>
<p>size：每页大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">    	&quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;from&quot;: 3,</span><br><span class="line">    &quot;size&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h2><p>服务端搜索数据，得到搜索结果 ；把搜索结果中，把搜索关键字加上前缀与后缀 ；前端页面提前写好标签的CSS样式，即可高亮</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;hui&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">        	&quot;title&quot;: &quot;手机&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;: &#123;</span><br><span class="line">        &quot;pre_tags&quot;: &quot;&lt;em&gt;&quot;,     # 前缀</span><br><span class="line">        &quot;post_tags&quot;: &quot;&lt;&#x2F;em&gt;&quot;,   # 后缀</span><br><span class="line">        &quot;fields&quot;: &#123;  			# 需要高亮的字段</span><br><span class="line">        	&quot;title&quot;: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h1><p>聚合可以让我们极其方便的实现对数据的统计、分析</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>Elasticsearch中的聚合，包含多种类型，最常用的两种，一个叫 桶 ，一个叫 度量 </p>
<p><strong>桶</strong></p>
<p>类似于 group by，是按照某种方式对数据进行分组，每一组数据在ES中称为一个 桶 </p>
<p>划分桶的方式：</p>
<ul>
<li>Date Histogram Aggregation：根据日期阶梯分组，例如给定阶梯为周，会自动每周分为一组 </li>
<li>Histogram Aggregation：根据数值阶梯分组，与日期类似，需要知道分组的间隔（interval）</li>
<li>Terms Aggregation：根据词条内容分组，词条内容完全匹配的为一组 </li>
<li>Range Aggregation：数值和日期的范围分组，指定开始和结束，然后按段分组</li>
<li>…….</li>
</ul>
<p><strong>度量</strong></p>
<p>相当于聚合的结果，分组完成以后，一般会对组中的数据进行聚合运算，这些在 ES中称为 度量 </p>
<p>比较常用的度量聚合方式：</p>
<ul>
<li>Avg Aggregation：求平均值 </li>
<li>Max Aggregation：求最大值 </li>
<li>Min Aggregation：求最小值 </li>
<li>Percentiles Aggregation：求百分比 </li>
<li>Stats Aggregation：同时返回avg、max、min、sum、count等 </li>
<li>Sum Aggregation：求和 </li>
<li>Top hits Aggregation：求前几 </li>
<li>Value Count Aggregation：求总数</li>
<li>……</li>
</ul>
<p><strong>注意</strong>：在ES中，需要进行聚合、排序、过滤的字段其处理方式比较特殊，因此不能被分词，必须使用 keyword 或 数值类型 。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>创建一个索引，并导入一些数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;car</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;orders&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;color&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;make&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照 汽车的颜色 color来 划分 桶 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;car&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot; : 0,  # 查询条数，不关心搜索到的数据，只关心聚合结果，提高效率</span><br><span class="line">    &quot;aggs&quot; : &#123;   # 聚合查询，是aggregations的缩写</span><br><span class="line">        &quot;popular_colors&quot; : &#123;  # 聚合起一个名字，可任意指定。</span><br><span class="line">            &quot;terms&quot; : &#123;		  # 聚合的类型，这里选择terms</span><br><span class="line">            	&quot;field&quot; : &quot;color&quot;  # 划分桶时依赖的字段</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看结果，只分析聚合中的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&quot;aggregations&quot;: &#123;  # 聚合的结果</span><br><span class="line">    &quot;popular_colors&quot;: &#123;   # 我们自定义的聚合名称</span><br><span class="line">        &quot;doc_count_error_upper_bound&quot;: 0,</span><br><span class="line">        &quot;sum_other_doc_count&quot;: 0,</span><br><span class="line">        &quot;buckets&quot;: [  # 查找到的桶，每个不同的color字段值都会形成一个桶</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;key&quot;: &quot;红&quot;,  # 这个桶对应的color字段的值</span><br><span class="line">                &quot;doc_count&quot;: 4  # 桶对应的个数</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;key&quot;: &quot;绿&quot;,</span><br><span class="line">                &quot;doc_count&quot;: 2</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;key&quot;: &quot;蓝&quot;,</span><br><span class="line">                &quot;doc_count&quot;: 2</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为刚刚的聚合结果添加 求价格平均值的<strong>度量</strong>，这些信息要嵌套在 桶 内， 度量 的运算会基于 桶 内的文档进行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;car&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot; : 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;popular_colors&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123;</span><br><span class="line">            	&quot;field&quot; : &quot;color&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;aggs&quot;:&#123;  # 我们在上一个aggs(popular_colors)中添加新的aggs。可见度量也是一个聚合.</span><br><span class="line">                &quot;avg_price&quot;: &#123;  # 聚合的名称</span><br><span class="line">                    &quot;avg&quot;: &#123;    # 度量的类型，这里是求平均值</span><br><span class="line">                    	&quot;field&quot;: &quot;price&quot;  # 度量运算的字段</span><br><span class="line">                	&#125;</span><br><span class="line">            	&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看结果,只分析桶中的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;buckets&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;key&quot;: &quot;红&quot;,</span><br><span class="line">        &quot;doc_count&quot;: 4,</span><br><span class="line">        &quot;avg_price&quot;: &#123;  	# 自定义度量的名称</span><br><span class="line">        	&quot;value&quot;: 32500  # 平均值度量后的结果</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;key&quot;: &quot;绿&quot;,</span><br><span class="line">        &quot;doc_count&quot;: 2,</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">        	&quot;value&quot;: 21000</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h1 id="ElasticSearch集群"><a href="#ElasticSearch集群" class="headerlink" title="ElasticSearch集群"></a>ElasticSearch集群</h1><p><strong>单点的问题</strong> </p>
<ul>
<li>单台机器存储容量有限，无法实现高存储 </li>
<li>单服务器容易出现单点故障，无法实现高可用 </li>
<li>单服务的并发处理能力有限，无法实现高并发 </li>
</ul>
<p>所以，为了应对这些问题，我们需要对elasticsearch搭建集群</p>
<h2 id="集群的结构"><a href="#集群的结构" class="headerlink" title="集群的结构"></a>集群的结构</h2><p><strong>数据分片(Shard)</strong> </p>
<p>数据量太大，单点存储量有限的问题。es数据拆分成多份，每一份存储到不同机器节点（node），从而实现减少每个节点数据量大的目的，这就是数据的分布式存储。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4tbZ38"><img src="https://z3.ax1x.com/2021/09/22/4tbZ38.png" alt="4tbZ38.png"></a></p>
<p><strong>数据副本(replica)</strong> </p>
<p>如果出现单点故障，那么分片数据就不再完整。es给每个分片数据进行备份，存储到其它节点，防止数据丢失。 数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本比较高。</p>
<p>为了在高可用和成本间寻求平衡，我们可以这样做： </p>
<p>首先对数据分片，存储到不同节点 。然后对每个分片进行备份，放到对方节点，完成<strong>互相备份</strong> </p>
<p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4tbmjg"><img src="https://z3.ax1x.com/2021/09/22/4tbmjg.png" alt="4tbmjg.png"></a></p>
<h2 id="集群的搭建"><a href="#集群的搭建" class="headerlink" title="集群的搭建"></a>集群的搭建</h2><p>一台机器进行模拟：将我们的ES的安装包复制三份，修改端口号，data和log存放位置的不同。 </p>
<p>实际开发中：将每个ES节点放在不同的服务器上。 </p>
<p>我们计划集群名称为：hui-elastic，部署3个elasticsearch节点，分别是： </p>
<ul>
<li>node-01：http端口9201，TCP端口9301 </li>
<li>node-02：http端口9202，TCP端口9302 </li>
<li>node-03：http端口9203，TCP端口9303</li>
</ul>
<p>步骤：</p>
<p>1）复制es软件3次，分别修改名称</p>
<p>2）修改每一个节点 config下的elasticsearch.yml 配置文件,三个节点的配置文件几乎一致，除了：</p>
<p>​        node.name、path.data、path.log、http.port、 transport.tcp.port</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#允许跨域名访问</span></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#当设置允许跨域，默认为*,表示支持所有域名</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="comment">#允许所有节点访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment"># 集群的名称，同一个集群下所有节点的集群名称应该一致</span></span><br><span class="line">cluster.name: hui-elastic</span><br><span class="line"><span class="comment">#当前节点名称 每个节点不一样</span></span><br><span class="line">node.name: node-01</span><br><span class="line"><span class="comment">#数据的存放路径 每个节点不一样，不同es服务器对应的data和log存储的路径不能一样</span></span><br><span class="line">path.data: d:\class\es-9201\data</span><br><span class="line"><span class="comment">#日志的存放路径 每个节点不一样</span></span><br><span class="line">path.logs: d:\class\es-9201\logs</span><br><span class="line"><span class="comment"># http协议的对外端口 每个节点不一样，默认：9200</span></span><br><span class="line">http.port: 9201</span><br><span class="line"><span class="comment"># TCP协议对外端口 每个节点不一样，默认：9300</span></span><br><span class="line">transport.tcp.port: 9301</span><br><span class="line"><span class="comment">#三个节点相互发现，包含自己，使用tcp协议的端口号</span></span><br><span class="line">discovery.zen.ping.unicast.hosts:</span><br><span class="line">[<span class="string">&quot;127.0.0.1:9301&quot;</span>,<span class="string">&quot;127.0.0.1:9302&quot;</span>,<span class="string">&quot;127.0.0.1:9303&quot;</span>]</span><br><span class="line"><span class="comment">#声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"><span class="comment"># 是否为主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>3）启动集群 </p>
<p>把三个节点分别启动,启动时不要着急，要一个一个地启动，可使用head方便查看集群状态。</p>
<h2 id="集群工作原理"><a href="#集群工作原理" class="headerlink" title="集群工作原理"></a>集群工作原理</h2><p><strong>shad与replica机制</strong></p>
<ul>
<li>增减节点时，shard会自动在nodes中负载均衡</li>
<li>replica shard是primary shard的副本，负责容错，以及承担<strong>读请求负载</strong></li>
<li>primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随时修改</li>
<li>primary shard不能和自己的replica shard放在同一个节点上，起不到容错的作用</li>
</ul>
<p><strong>集群写入数据</strong> </p>
<ol>
<li>客户端选择一个node发送请求过去，这个node就是coordinating node (协调节点) </li>
<li>coordinating node，对document进行路由，将请求转发给对应的node。（根据一定的算法选择 对应的节点进行存储） </li>
<li>node上的primary shard处理请求，将数据保存在本地，然后将数据同步到replica node </li>
<li>coordinating node，如果发现primary node和所有的replica node都搞定之后，就会返回请求到 客户端</li>
</ol>
<p>这个路由简单的说就是取模算法，例如:有3台服务器,这个时候传过来的id是5,那么5%3=2,就 放在第2台服务器。</p>
<h1 id="ElasticSearch客户端"><a href="#ElasticSearch客户端" class="headerlink" title="ElasticSearch客户端"></a>ElasticSearch客户端</h1><p>在elasticsearch官网中提供了各种语言的客户端：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a> </p>
<p>这里安装的都是 6.2.4 版本，所以选择版本到 6.2.4，java高级REST客户端。</p>
<h2 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h2><p>创建spirngboot项目，并导入pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--google提供的处理JSON工具包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Apache开源组织提供的用于操作JAVA BEAN的工具包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--ES高级Rest Client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写Product实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="keyword">private</span> String brand; <span class="comment">// 品牌</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格</span></span><br><span class="line">    <span class="keyword">private</span> String images; <span class="comment">// 图片地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建索引库及映射"><a href="#创建索引库及映射" class="headerlink" title="创建索引库及映射"></a>创建索引库及映射</h2><p>创建索引库的同时，我们也会创建type及其映射关系，但是这些操作不建议使用java客户端完成。</p>
<p>这里使用kibana提前完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;hui</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 3,</span><br><span class="line">        &quot;number_of_replicas&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;item&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;id&quot;: &#123;</span><br><span class="line">                	&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;title&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                    &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;category&quot;: &#123;</span><br><span class="line">                	&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;brand&quot;: &#123;</span><br><span class="line">                	&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;images&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;index&quot;: false</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;price&quot;: &#123;</span><br><span class="line">                	&quot;type&quot;: &quot;double&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="索引数据操作"><a href="#索引数据操作" class="headerlink" title="索引数据操作"></a>索引数据操作</h2><h3 id="初始化客户端"><a href="#初始化客户端" class="headerlink" title="初始化客户端"></a>初始化客户端</h3><p>在测试类中编写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化HighLevel客户端</span></span><br><span class="line">        client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)</span><br><span class="line">                        <span class="comment">// ,new HttpHost(&quot;127.0.0.1&quot;,9201) // 集群</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="新增与修改文档"><a href="#新增与修改文档" class="headerlink" title="新增与修改文档"></a>新增与修改文档</h3><p>如果id不存在就是插入，否则修该</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON转换工具</span></span><br><span class="line"><span class="keyword">private</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果id不存在就是插入，否则修改</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertAndUpdate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.获取文档数据</span></span><br><span class="line">    Product product = <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">&quot;小米手机&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">2623D</span>, <span class="string">&quot;http://xiaomi.com&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.将文档数据转换成JSON格式</span></span><br><span class="line">    String source = gson.toJson(product);</span><br><span class="line">    <span class="comment">// 3.创建索引请求对象 访问哪个索引库、哪个type、指定文档ID</span></span><br><span class="line">    IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;hui&quot;</span>, <span class="string">&quot;item&quot;</span>, product.getId().toString());</span><br><span class="line">    request.source(source, XContentType.JSON); <span class="comment">// 放入数据，并指定为json格式</span></span><br><span class="line">    <span class="comment">// 4.发出请求</span></span><br><span class="line">    IndexResponse response = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response); <span class="comment">// 打印结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h3><p>根据rest风格，查看应该是根据id进行get查询，难点是对结果的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建get请求对象</span></span><br><span class="line">    GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;hui&quot;</span>, <span class="string">&quot;item&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.发送请求,获得响应</span></span><br><span class="line">    GetResponse response = client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 3.解析响应</span></span><br><span class="line">    String sourceAsString = response.getSourceAsString(); <span class="comment">// 将数据转换成JSON字符串格式</span></span><br><span class="line">    <span class="comment">// 转换成Product对象</span></span><br><span class="line">    Product product = gson.fromJson(sourceAsString, Product.class);</span><br><span class="line">    System.out.println(product); <span class="comment">// 打印结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p>根据id删除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建delete请求</span></span><br><span class="line">    DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;hui&quot;</span>, <span class="string">&quot;item&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.发送请求</span></span><br><span class="line">    DeleteResponse response = client.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h2><h3 id="查询所有match-all"><a href="#查询所有match-all" class="headerlink" title="查询所有match_all"></a>查询所有match_all</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">matchAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建搜索请求</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 创建查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.发送请求</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.解析数据</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 取出source数据</span></span><br><span class="line">        String sourceAsString = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">// 转换成Product对象</span></span><br><span class="line">        Product product = gson.fromJson(sourceAsString, Product.class);</span><br><span class="line">        <span class="keyword">if</span> (product.getId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索条件是通过 <code>sourceBuilder.query(QueryBuilders.matchAllQuery())</code> 来添加的。这个 query() 方法接受的参数是： <strong>QueryBuilder 接口</strong>类型。</p>
<p>这个接口提供了很多实现类，分别对应不同类型的查询，例如：term查询、match 查询、range查询、boolean查询等。</p>
<p>这些实现类不需要我们去 new ，官方提供了 QueryBuilders 工厂帮我们构建各种实现类：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4tOhVJ"><img src="https://z3.ax1x.com/2021/09/22/4tOhVJ.png" alt="4tOhVJ.png"></a></p>
<h3 id="关键字搜索match"><a href="#关键字搜索match" class="headerlink" title="关键字搜索match"></a>关键字搜索match</h3><p>搜索类型的变化，仅仅是利用QueryBuilders构建的查询对象不同而已，其他代码基本一致</p>
<p>因此，我们可以把这段代码封装，然后把查询条件作为参数传递</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封装 搜索</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">baseSearch</span><span class="params">(SearchSourceBuilder sourceBuilder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建搜索请求</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.发送请求</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.解析</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 取出source数据</span></span><br><span class="line">        String sourceAsString = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">// 转换成Product对象</span></span><br><span class="line">        Product product = gson.fromJson(sourceAsString, Product.class);</span><br><span class="line">        <span class="keyword">if</span> (product.getId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键字搜索代码</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBaseSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;手机&quot;</span>));</span><br><span class="line">    <span class="comment">// 调用封装的方法,并传递查询条件</span></span><br><span class="line">    baseSearch(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="范围查询range"><a href="#范围查询range" class="headerlink" title="范围查询range"></a>范围查询range</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rangeSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    RangeQueryBuilder price = QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">    price.gte(<span class="string">&quot;3000&quot;</span>); <span class="comment">// &gt;=</span></span><br><span class="line">    price.lte(<span class="string">&quot;5000&quot;</span>); <span class="comment">// &lt;=</span></span><br><span class="line">    sourceBuilder.query(price);</span><br><span class="line">    <span class="comment">// 调用封装的方法,并传递查询条件</span></span><br><span class="line">    baseSearch(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="source过滤"><a href="#source过滤" class="headerlink" title="source过滤"></a>source过滤</h3><p>默认情况下，索引库中所有数据都会返回，如果只返回部分字段，可以通过source filter来控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sourceFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery()); <span class="comment">// 查询所有</span></span><br><span class="line">    <span class="comment">// 过滤字段 ，参数一：显示字段 ，参数二：不显示字段</span></span><br><span class="line">    sourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;price&quot;</span>&#125;, <span class="keyword">null</span>);</span><br><span class="line">  	<span class="comment">// 调用封装的方法,并传递查询条件</span></span><br><span class="line">    baseSearch(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="排序与分页"><a href="#排序与分页" class="headerlink" title="排序与分页"></a>排序与分页</h2><p>依然是通过sourceBuilder来配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sortSearch</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 创建查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，查询所有</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">//排序   价格降序</span></span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;price&quot;</span>,SortOrder.DESC); </span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    sourceBuilder.from(<span class="number">0</span>);  <span class="comment">// 偏移量</span></span><br><span class="line">    sourceBuilder.size(<span class="number">3</span>); </span><br><span class="line">	<span class="comment">// 调用封装的方法,并传递查询条件</span></span><br><span class="line">    baseSearch(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Spring-Data-ElasticSearch"><a href="#Spring-Data-ElasticSearch" class="headerlink" title="Spring Data ElasticSearch"></a>Spring Data ElasticSearch</h1><p>Spring Data ElasticSearch（以后简称SDE）是Spring Data项目下的一个子模块。 </p>
<p>Spring Data 的使命是给各种数据访问提供统一的编程接口。</p>
<p><strong>特征</strong> </p>
<ul>
<li>支持Spring的基于 @Configuration 的java配置方式，或者XML配置方式 </li>
<li>提供了用于操作ES的便捷工具类 ElasticsearchTemplate 。 </li>
<li>基于注解的元数据映射方式，而且可扩展以支持更多不同的数据格式，可以定义JavaBean：类 名、属性 </li>
<li>根据持久层接口自动生成对应实现方法，无需人工编写基本操作代码（类似mybatis，根据接口自 动得到实现）。当然，也支持人工定制查询</li>
</ul>
<h2 id="配置SDE"><a href="#配置SDE" class="headerlink" title="配置SDE"></a>配置SDE</h2><p><strong>依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">elasticsearch:</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">elasticsearch</span> <span class="comment"># 集群名称，默认elasticsearch</span></span><br><span class="line">      <span class="attr">cluster-nodes:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9300</span> <span class="comment"># 各个节点名称,可加逗号表示多个实例</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是，SDE底层使用的不是Elasticsearch提供的RestHighLevelClient， 而是TransportClient，并不采用Http协议通信，而是访问tcp端口</p>
<h2 id="索引库操作"><a href="#索引库操作" class="headerlink" title="索引库操作"></a>索引库操作</h2><h3 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h3><p>修改之前的Peoduct对象，添加相应的注解信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;hui&quot;, type = &quot;product&quot;, shards = 3, replicas = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span>  </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String brand; <span class="comment">// 品牌</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword,index = false)</span></span><br><span class="line">    <span class="keyword">private</span> String images; <span class="comment">// 图片地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Document：声明索引库配置 </p>
<ul>
<li>indexName：索引库名称 </li>
<li>type：类型名称，默认是“docs” </li>
<li>shards：分片数量，默认5 </li>
<li>replicas：副本数量，默认1 </li>
</ul>
<p>@Id：声明实体类的id </p>
<p>@Field：声明字段属性 </p>
<ul>
<li>type：字段的数据类型 </li>
<li>analyzer：指定分词器类型 </li>
<li>index：是否创建索引</li>
</ul>
<p><strong>创建索引库</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SDETest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        template.createIndex(Product.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><p>刚才的注解已经把映射关系也配置上了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建类型</span></span><br><span class="line">    template.putMapping(Product.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="索引数据CRUD"><a href="#索引数据CRUD" class="headerlink" title="索引数据CRUD"></a>索引数据CRUD</h2><p>SDE的索引数据CRUD并没有封装在ElasticsearchTemplate中，而是有一个叫做 ElasticsearchRepository的接口。</p>
<p>我们需要自定义接口，继承ElasticsearchRespository，就可以使用很多已经集成的方法，类似于mybatis-plus。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型&lt;实体类,id类型&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Product</span>,<span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建索引数据"><a href="#创建索引数据" class="headerlink" title="创建索引数据"></a>创建索引数据</h3><p><strong>保存单条数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductRepository productRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Product product = <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">&quot;小米手机&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">4452D</span>, <span class="string">&quot;http://xiaomi/img/1.jpg&quot;</span>);</span><br><span class="line">    productRepository.save(product);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>批量保存</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Product product1 = <span class="keyword">new</span> Product(<span class="number">2L</span>, <span class="string">&quot;华为手机&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">3333D</span>, <span class="string">&quot;http://xiaomi/img/1.jpg&quot;</span>);</span><br><span class="line">    Product product2 = <span class="keyword">new</span> Product(<span class="number">3L</span>, <span class="string">&quot;锤子手机&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;锤子&quot;</span>, <span class="number">2000D</span>, <span class="string">&quot;http://xiaomi/img/1.jpg&quot;</span>);</span><br><span class="line">    Product product3 = <span class="keyword">new</span> Product(<span class="number">4L</span>, <span class="string">&quot;苹果手机&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;apple&quot;</span>, <span class="number">9000D</span>, <span class="string">&quot;http://xiaomi/img/1.jpg&quot;</span>);</span><br><span class="line">    List&lt;Product&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(product1);</span><br><span class="line">    list.add(product2);</span><br><span class="line">    list.add(product3);</span><br><span class="line">    productRepository.saveAll(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查询索引数据"><a href="#查询索引数据" class="headerlink" title="查询索引数据"></a>查询索引数据</h3><p><strong>根据id查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Optional&lt;Product&gt; optional = productRepository.findById(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 默认数据，如果查询数据为空，就返回该条数据，optional是java8中的新特性</span></span><br><span class="line">    Product defaultProduct = <span class="keyword">new</span> Product();</span><br><span class="line">    defaultProduct.setTitle(<span class="string">&quot;无。。。。&quot;</span>);</span><br><span class="line">    Product product = optional.orElse(defaultProduct);</span><br><span class="line">    System.out.println(product);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查询所有</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Iterable&lt;Product&gt; iterable = productRepository.findAll();</span><br><span class="line">    iterable.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义方法查询"><a href="#自定义方法查询" class="headerlink" title="自定义方法查询"></a>自定义方法查询</h3><p>ProductRepository提供的查询方法有限，但是它却提供了非常强大的自定义查询功能。</p>
<p>只要遵循SpringData提供的语法，我们可以任意定义方法声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Product</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据价格区间查询</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> from 开始价格</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> to 结束价格</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 符合条件的goods</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">List&lt;Product&gt; <span class="title">findByPriceBetween</span><span class="params">(Double from,Double to)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无需写实现，SDE会自动帮我们实现该方法，我们可以直接使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 价格范围查询</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByRange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Product&gt; productList = productRepository.findByPriceBetween(<span class="number">3000D</span>, <span class="number">5000D</span>);</span><br><span class="line">    productList.forEach(System.out::pringln); <span class="comment">// 输出结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDE支持的一些语法示例：</p>
<table>
<thead>
<tr>
<th>Keyword</th>
<th>Sample</th>
<th>Elasticsearch Query String</th>
</tr>
</thead>
<tbody><tr>
<td>and</td>
<td>findByNameAndPrice</td>
<td>{“bool” : {“must” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</td>
</tr>
<tr>
<td>or</td>
<td>findByNameOrPrice</td>
<td>{“bool” : {“should” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</td>
</tr>
<tr>
<td>is</td>
<td>findByName</td>
<td>{“bool” : {“must” : {“field” : {“name” : “?”}}}}</td>
</tr>
<tr>
<td>not</td>
<td>findByNameNot</td>
<td>{“bool” : {“must_not” : {“field” : {“name” : “?”}}}}</td>
</tr>
<tr>
<td>between</td>
<td>findByPriceBetween</td>
<td>{“bool” : {“must” : {“range” : {“price” : {“from” : ?,”to” : ?,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td>LessThanEqual</td>
<td>findByPriceLessThan</td>
<td>{“price” : {“from” : null,”to” : ?,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td>GreaterThanEqual</td>
<td>findByPriceGreaterThan</td>
<td>{“bool” : {“must” : {“range” : {“price” : {“from” : ?,”to” : null,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td>Before</td>
<td>findByPriceBefore</td>
<td>{“bool” : {“must” : {“range” : {“price” : {“from” : null,”to” : ?,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td>After</td>
<td>findByPriceAfter</td>
<td>{“bool” : {“must” : {“range” : {“price” : {“from” : ?,”to” : null,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td>Like</td>
<td>findByNameLike</td>
<td>{“bool” : {“must” : {“field” : {“name” : {“query” : “? *”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td>StartingWith</td>
<td>findByNameStartingWith</td>
<td>{“bool” : {“must” : {“field” : {“name” : {“query” : “? *”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td>EndingWith</td>
<td>findByNameEndingWith</td>
<td>{“bool” : {“must” : {“field” : {“name” : {“query” : “*?”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td>Contains/Containing</td>
<td>findByNameContaining</td>
<td>{“bool” : {“must” : {“field” : {“name” : {“query” : “**? **”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td>In</td>
<td>findByNameIn(Collectionnames)</td>
<td>{“bool” : {“must” : {“bool” : {“should” : [ {“field” : {“name” : “?”}}, {“field” : {“name” : “?”}} ]}}}}</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByNameNotIn(Collectionnames)</td>
<td>{“bool” : {“must_not” : {“bool” : {“should” : {“field” : {“name” : “?”}}}}}}</td>
</tr>
<tr>
<td>Near</td>
<td>findByStoreNear</td>
<td>Not Supported Yet !</td>
</tr>
<tr>
<td>True</td>
<td>findByAvailableTrue</td>
<td>{“bool” : {“must” : {“field” : {“available” : true}}}}</td>
</tr>
<tr>
<td>False</td>
<td>findByAvailableFalse</td>
<td>{“bool” : {“must” : {“field” : {“available” : false}}}}</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAvailableTrueOrderByNameDesc</td>
<td>{“sort” : [{ “name” : {“order” : “desc”} }],”bool” : {“must” : {“field” : {“available” : true}}}}</td>
</tr>
</tbody></table>
<h2 id="原生查询"><a href="#原生查询" class="headerlink" title="原生查询"></a>原生查询</h2><p>SDE也支持原生查询，这个时候还是使用 ElasticsearchTemplate</p>
<p>查询条件的构建是通过一个名为 NativeSearchQueryBuilder 的类来完成的，不过这个类的底层还 是使用的原生API中的 QueryBuilders 、 AggregationBuilders 、 HighlightBuilders 等工具。</p>
<p><strong>需求</strong>： 查询title中包含小米手机的商品，以价格升序排序，分页查询：每页展示2条，查询第1页。 对查询结果进行聚合分析：获取品牌及个数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nativeSearch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 原生查询构建器</span></span><br><span class="line">    NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">//   source过滤</span></span><br><span class="line">    builder.withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;price&quot;</span>, <span class="string">&quot;brand&quot;</span>&#125;, <span class="keyword">null</span>));</span><br><span class="line">    <span class="comment">//   搜索条件</span></span><br><span class="line">    builder.withQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;手机&quot;</span>));</span><br><span class="line">    <span class="comment">//   分页及排序条件</span></span><br><span class="line">    builder.withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">3</span>, Sort.by(Sort.Direction.ASC, <span class="string">&quot;price&quot;</span>)));</span><br><span class="line">    <span class="comment">//   高亮显示(下面再编写，这里省略)</span></span><br><span class="line">    <span class="comment">// builder.withHighlightBuilder(new HighlightBuilder().field(&quot;title&quot;));</span></span><br><span class="line">    <span class="comment">//   聚合</span></span><br><span class="line">    builder.addAggregation(AggregationBuilders.terms(<span class="string">&quot;brandAgg&quot;</span>).field(<span class="string">&quot;brand&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询条件，并且查询</span></span><br><span class="line">    AggregatedPage&lt;Product&gt; result = template.queryForPage(builder.build(), Product.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析结果</span></span><br><span class="line">    <span class="comment">// 分页结果</span></span><br><span class="line">    <span class="keyword">long</span> total = result.getTotalElements();</span><br><span class="line">    <span class="keyword">int</span> pages = result.getTotalPages();</span><br><span class="line">    List&lt;Product&gt; list = result.getContent();</span><br><span class="line">    System.out.println(<span class="string">&quot;总数:&quot;</span> + total);</span><br><span class="line">    System.out.println(<span class="string">&quot;页数:&quot;</span> + pages);</span><br><span class="line">    System.out.println(<span class="string">&quot;内容:&quot;</span>);</span><br><span class="line">    list.forEach(System.out::pringln);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 聚合结果</span></span><br><span class="line">    Aggregations aggregations = result.getAggregations();</span><br><span class="line">    Terms Terms = aggregations.get(<span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">    <span class="comment">// 遍历桶中的数据</span></span><br><span class="line">    Terms.getBuckets().forEach(item -&gt; &#123;</span><br><span class="line">        System.out.println(item.getKeyAsString() + <span class="string">&quot;==&gt;&quot;</span> + item.getDocCount());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>高亮展示</strong></p>
<p>自定义搜索结果映射，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyResultMapper</span> <span class="keyword">implements</span> <span class="title">SearchResultMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> aClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AggregatedPage需要3给参数:List&lt;T&gt;,pageable,总记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">AggregatedPage&lt;T&gt; <span class="title">mapResults</span><span class="params">(SearchResponse searchResponse, Class&lt;T&gt; aClass, Pageable pageable)</span> </span>&#123;</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="comment">// 保存所有的记录，用与返回</span></span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 获取搜索结果(真正的的记录)</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">// 遍历每一条记录</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hit == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 每一条数据映射成map对象</span></span><br><span class="line">            Map&lt;String, Object&gt; map = hit.getSourceAsMap();</span><br><span class="line">            <span class="comment">// 获取高亮字段</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">            <span class="comment">// 遍历高亮字段，将高亮字段覆盖原来的记录</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, HighlightField&gt; entry : highlightFields.entrySet()) &#123;</span><br><span class="line">                String key = entry.getKey(); <span class="comment">// 高亮字段key</span></span><br><span class="line">                HighlightField value = entry.getValue(); <span class="comment">// 高亮字段value</span></span><br><span class="line">                Text[] texts = value.getFragments(); <span class="comment">// 实际fragments[0]就是高亮的结果，无需遍历拼接</span></span><br><span class="line">                <span class="comment">// 因为高亮的字段必然存在于Map中，就是key值，所以这里是直接覆盖</span></span><br><span class="line">                map.put(key, texts[<span class="number">0</span>].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将map转换成原来的对象T</span></span><br><span class="line">            T t = gson.fromJson(gson.toJson(map), aClass);</span><br><span class="line">            <span class="comment">// 将对象保存到list集合中</span></span><br><span class="line">            list.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回的是带分页的结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AggregatedPageImpl(list, pageable, searchResponse.getHits().getTotalHits());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>高亮实现，查询时要创建 SearchResultMapper 实现类，用于接收高亮数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">highlightSearch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 原生查询构建器</span></span><br><span class="line">    NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">//   搜索条件</span></span><br><span class="line">    builder.withQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;手机&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//   高亮显示</span></span><br><span class="line">    HighlightBuilder.Field field = <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">    field.preTags(<span class="string">&quot;&lt;font style=&#x27;color:red&#x27;&gt;&quot;</span>);  <span class="comment">// 前缀</span></span><br><span class="line">    field.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>); <span class="comment">// 后缀</span></span><br><span class="line">    builder.withHighlightFields(field);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询条件，并且查询</span></span><br><span class="line">    AggregatedPage&lt;Product&gt; result = template.queryForPage(builder.build(), Product.class, <span class="keyword">new</span> MyResultMapper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析结果</span></span><br><span class="line">    List&lt;Product&gt; list = result.getContent();</span><br><span class="line">    System.out.println(<span class="string">&quot;内容:&quot;</span>);</span><br><span class="line">    list.forEach(System.out::pringln);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ES在docker上部署"><a href="#ES在docker上部署" class="headerlink" title="ES在docker上部署"></a>ES在docker上部署</h1><h2 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h2><p><strong>拉取</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:6.5.4</span><br></pre></td></tr></table></figure>
<p><strong>开启镜像</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e &quot;ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m&quot; --name es_6.5.4 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type&#x3D;single-node&quot; elasticsearch:6.5.4</span><br></pre></td></tr></table></figure>
<h2 id="安装ik分词器"><a href="#安装ik分词器" class="headerlink" title="安装ik分词器"></a>安装ik分词器</h2><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>版本要与es版本一致，这里 下载了 elasticsearch-analysis-ik-6.5.4.zip 压缩包</p>
<p>1)上传压缩包到 /home 目录</p>
<p>2)将压缩包解压至es容器的 /usr/share/elasticsearch/plugins/ik 中   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 压缩包移动到容器中 </span><br><span class="line">docker cp &#x2F;home&#x2F;elasticsearch-analysis-ik-5.6.12.zip es:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins</span><br><span class="line"># 进入容器</span><br><span class="line">docker exec -it es &#x2F;bin&#x2F;bash</span><br><span class="line"># 进入plugins目录</span><br><span class="line">cd &#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins</span><br><span class="line"># 创建ik目录</span><br><span class="line">mkdir ik</span><br><span class="line"># 将压缩包移动到ik中</span><br><span class="line">mv elasticsearch-analysis-ik-5.6.12.zip ik&#x2F;</span><br><span class="line"># 进入目录，并解压</span><br><span class="line">cd ik&#x2F;</span><br><span class="line">unzip elasticsearch-analysis-ik-5.6.12.zip</span><br><span class="line"># 删除压缩包</span><br><span class="line">rm -rf elasticsearch-analysis-ik-5.6.12.zip</span><br></pre></td></tr></table></figure>
<p>3)退出容器，并重启容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">docker restart es</span><br></pre></td></tr></table></figure>
<p>如果启动类kibana，也要重启kibana</p>
<h2 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h2><p><strong>拉取</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kibana:6.5.4</span><br></pre></td></tr></table></figure>
<p><strong>开启镜像</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name kibana -e ELASTICSEARCH_URL&#x3D;http:&#x2F;&#x2F;192.168.200.128:9200 -p 5601:5601 -d kibana:6.5.4</span><br></pre></td></tr></table></figure>
<p>需指定ElasticSearch的位置</p>
<p>over。。。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>感谢老铁们的支持!!!</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/weChatPay.png" alt="怪狗狗 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/aliPay.jpg" alt="怪狗狗 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/lucene/" rel="tag"> lucene</a>
              <a href="/tags/ElasticSearch/" rel="tag"> ElasticSearch</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/14/SpringCloud/" rel="prev" title="SpringCloud">
      <i class="fa fa-chevron-left"></i> SpringCloud
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/22/docker%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/" rel="next" title="docker虚拟化技术">
      docker虚拟化技术 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#lucene%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">lucene相关概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#lucene%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">lucene的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">2.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">2.2.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95"><span class="nav-number">2.3.</span> <span class="nav-text">查询索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">2.4.</span> <span class="nav-text">中文分词器的使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ElasticSearch%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="nav-number">3.</span> <span class="nav-text">ElasticSearch介绍与安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.</span> <span class="nav-text">安装与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kibana"><span class="nav-number">3.2.</span> <span class="nav-text">安装kibana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">3.3.</span> <span class="nav-text">安装Ik分词器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Head%E6%8F%92%E4%BB%B6"><span class="nav-number">3.4.</span> <span class="nav-text">安装Head插件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kibana%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">4.</span> <span class="nav-text">kibana的相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">4.1.</span> <span class="nav-text">对索引库操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E7%B1%BB%E5%9E%8B%E4%B8%8E%E6%98%A0%E5%B0%84%E6%93%8D%E4%BD%9C"><span class="nav-number">4.2.</span> <span class="nav-text">对类型与映射操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%A0%E5%B0%84%E5%B1%9E%E6%80%A7%E8%AF%A6%E8%A7%A3"><span class="nav-number">4.2.1.</span> <span class="nav-text">映射属性详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#type"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#store"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">store</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boost"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">boost</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="nav-number">4.3.</span> <span class="nav-text">对文档操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.1.</span> <span class="nav-text">基本查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89-match-all"><span class="nav-number">5.1.1.</span> <span class="nav-text">查询所有(match_all)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2-match"><span class="nav-number">5.1.2.</span> <span class="nav-text">匹配查询(match)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%8D%E6%9D%A1%E5%8C%B9%E9%85%8D-term"><span class="nav-number">5.1.3.</span> <span class="nav-text">词条匹配(term)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%83%E5%B0%94%E7%BB%84%E5%90%88-bool"><span class="nav-number">5.1.4.</span> <span class="nav-text">布尔组合(bool)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-range"><span class="nav-number">5.1.5.</span> <span class="nav-text">范围查询(range)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-fuzzy"><span class="nav-number">5.1.6.</span> <span class="nav-text">模糊查询(fuzzy)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4"><span class="nav-number">5.2.</span> <span class="nav-text">结果过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5"><span class="nav-number">5.2.1.</span> <span class="nav-text">直接指定字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9Aincludes%E5%92%8Cexcludes"><span class="nav-number">5.2.2.</span> <span class="nav-text">指定includes和excludes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%EF%BC%88filter%EF%BC%89"><span class="nav-number">5.3.</span> <span class="nav-text">过滤（filter）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">5.4.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%A1%B5"><span class="nav-number">5.5.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE"><span class="nav-number">5.6.</span> <span class="nav-text">高亮</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%81%9A%E5%90%88"><span class="nav-number">6.</span> <span class="nav-text">聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">6.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">6.2.</span> <span class="nav-text">案例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ElasticSearch%E9%9B%86%E7%BE%A4"><span class="nav-number">7.</span> <span class="nav-text">ElasticSearch集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">7.1.</span> <span class="nav-text">集群的结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="nav-number">7.2.</span> <span class="nav-text">集群的搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">7.3.</span> <span class="nav-text">集群工作原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ElasticSearch%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">8.</span> <span class="nav-text">ElasticSearch客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-1"><span class="nav-number">8.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93%E5%8F%8A%E6%98%A0%E5%B0%84"><span class="nav-number">8.2.</span> <span class="nav-text">创建索引库及映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">8.3.</span> <span class="nav-text">索引数据操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">8.3.1.</span> <span class="nav-text">初始化客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E4%B8%8E%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="nav-number">8.3.2.</span> <span class="nav-text">新增与修改文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="nav-number">8.3.3.</span> <span class="nav-text">查看文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">8.3.4.</span> <span class="nav-text">删除文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">8.4.</span> <span class="nav-text">搜索数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89match-all"><span class="nav-number">8.4.1.</span> <span class="nav-text">查询所有match_all</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2match"><span class="nav-number">8.4.2.</span> <span class="nav-text">关键字搜索match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2range"><span class="nav-number">8.4.3.</span> <span class="nav-text">范围查询range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#source%E8%BF%87%E6%BB%A4"><span class="nav-number">8.4.4.</span> <span class="nav-text">source过滤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="nav-number">8.5.</span> <span class="nav-text">排序与分页</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Data-ElasticSearch"><span class="nav-number">9.</span> <span class="nav-text">Spring Data ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AESDE"><span class="nav-number">9.1.</span> <span class="nav-text">配置SDE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">9.2.</span> <span class="nav-text">索引库操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">9.2.1.</span> <span class="nav-text">创建索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">9.2.2.</span> <span class="nav-text">创建映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AECRUD"><span class="nav-number">9.3.</span> <span class="nav-text">索引数据CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="nav-number">9.3.1.</span> <span class="nav-text">创建索引数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="nav-number">9.3.2.</span> <span class="nav-text">查询索引数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%E6%9F%A5%E8%AF%A2"><span class="nav-number">9.3.3.</span> <span class="nav-text">自定义方法查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">9.4.</span> <span class="nav-text">原生查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ES%E5%9C%A8docker%E4%B8%8A%E9%83%A8%E7%BD%B2"><span class="nav-number">10.</span> <span class="nav-text">ES在docker上部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2ElasticSearch"><span class="nav-number">10.1.</span> <span class="nav-text">部署ElasticSearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">10.2.</span> <span class="nav-text">安装ik分词器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Kibana"><span class="nav-number">10.3.</span> <span class="nav-text">部署Kibana</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="怪狗狗"
      src="/images/jerry.jpg">
  <p class="site-author-name" itemprop="name">怪狗狗</p>
  <div class="site-description" itemprop="description">跑得又快，长得又帅</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">74</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/oddDog-git" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oddDog-git" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://1764501567@qq.com/" title="E-Mail → https:&#x2F;&#x2F;1764501567@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://wpa.qq.com/msgrd?v=3&uin=1764501567&site=qq&menu=yes" title="http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;1764501567&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener" target="_blank">加我QQ</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">怪狗狗</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div> -->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'YVPmrsyUdC4uV9bapDgb8ll6-gzGzoHsz',
      appKey     : 'MUI57EQtRoMQjLvpW68kiNyE',
      placeholder: "快来评论吧！！！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
