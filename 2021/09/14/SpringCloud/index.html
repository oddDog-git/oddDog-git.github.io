<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"odddog-git.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="随着互联⽹的发展，⽤户群体逐渐扩大，⽹站的流量成倍增⻓，常规的单体架构已⽆法满⾜请求压⼒ 和业务的快速迭代，架构的变化势在必⾏。">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://odddog-git.github.io/2021/09/14/SpringCloud/index.html">
<meta property="og:site_name" content="hui&#39;s Blog">
<meta property="og:description" content="随着互联⽹的发展，⽤户群体逐渐扩大，⽹站的流量成倍增⻓，常规的单体架构已⽆法满⾜请求压⼒ 和业务的快速迭代，架构的变化势在必⾏。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AElKx.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4Akz11.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AmSe0.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AWbrD.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AWjIA.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AX7bn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4AxnAI.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4ES8Ts.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/14/4EScfx.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VfpM6.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4V5gln.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VI5ut.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4V7eAK.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VHEvj.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VHjiT.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VqP1g.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4VLMIP.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4Zep1e.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4ZLKkq.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4ZLQhV.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/15/4ZXiQS.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eDJb9.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4esD7d.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eyGDg.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4e6ER0.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4ec74A.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4ecTNd.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4ehKcn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eo0Re.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eT1Ff.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eHcZR.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4ebJSO.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/16/4eXkB4.png">
<meta property="article:published_time" content="2021-09-14T08:16:13.000Z">
<meta property="article:modified_time" content="2021-09-18T00:37:57.042Z">
<meta property="article:author" content="怪狗狗">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://z3.ax1x.com/2021/09/14/4AElKx.png">

<link rel="canonical" href="http://odddog-git.github.io/2021/09/14/SpringCloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud | hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://oddDog-git" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://odddog-git.github.io/2021/09/14/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/jerry.jpg">
      <meta itemprop="name" content="怪狗狗">
      <meta itemprop="description" content="踏上新征程----go！！！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hui's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-14 16:16:13" itemprop="dateCreated datePublished" datetime="2021-09-14T16:16:13+08:00">2021-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-18 08:37:57" itemprop="dateModified" datetime="2021-09-18T08:37:57+08:00">2021-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/09/14/SpringCloud/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/09/14/SpringCloud/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>随着互联⽹的发展，⽤户群体逐渐扩大，⽹站的流量成倍增⻓，常规的单体架构已⽆法满⾜请求压⼒ 和业务的快速迭代，架构的变化势在必⾏。<a id="more"></a></p>
<h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><p><strong>SOA</strong> (Service-Oriented Architecture)，即面向服务的架构。根据实际业务，把系统拆分成合适 的、独立部署的模块，模块之间相互独立（通过Webservice/Dubbo等技术进行通信）。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AElKx"><img src="https://z3.ax1x.com/2021/09/14/4AElKx.png" alt="4AElKx.png"></a></p>
<p><strong>微服务架构</strong>  </p>
<p>可以说是<strong>SOA架构</strong>的一种拓展，这种架构模式下它拆分粒度更小、服务更独立。把应用 拆分成为一个个微小的服务，不同的服务可以使用不同的开发语言和存储，服务之间往往通过Restful等 轻量级通信。微服务架构关键在于微小、独立、轻量级通信。 </p>
<p>微服务是在 SOA 上做的升华粒度更加细致，微服务架构强调的⼀个重点是业务需要彻底的组件化和 服务化</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4Akz11"><img src="https://z3.ax1x.com/2021/09/14/4Akz11.png" alt="4Akz11.png"></a></p>
<p><strong>优点</strong></p>
<ul>
<li>微服务很小，便于特定业务功能的聚焦 </li>
<li>微服务很小，每个微服务都可以被一个小团队单独实施（开发、测试、部署上线、运维），团队合 作一定程度解耦，便于实施敏捷开发 </li>
<li>微服务很小，便于重用和模块之间的组装 </li>
<li>微服务很独立，那么不同的微服务可以使用不同的语言开发，松耦合 </li>
<li>微服务架构下，我们更容易引入新技术</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>微服务架构下，分布式复杂难以管理，当服务数量增加，管理将越加复杂；</li>
<li>微服务架构下，分布式链路跟踪难等；</li>
</ul>
<h1 id="SpringCloud介绍"><a href="#SpringCloud介绍" class="headerlink" title="SpringCloud介绍"></a>SpringCloud介绍</h1><p>Spring Cloud其实是一套规范，是一套用于构建微服务架构的规范，而不是一个 可以拿来即用的框架。在这个规范之下第三方的Netflix公司开发了一些组件、Spring官方开发了一些框架/组件，包括第 三方的阿里巴巴开发了一套框架/组件集合Spring Cloud Alibaba，这些才是Spring Cloud规范的实现。</p>
<p><strong>SpringCloud解决的问题</strong></p>
<ul>
<li>Distributed/versioned configuration （分布式/版本化配置） </li>
<li>Service registration and discovery （服务注册和发现） </li>
<li>Routing （智能路由） </li>
<li>Service-to-service calls （服务调用）</li>
<li>Load balancing （负载均衡） </li>
<li>Circuit Breakers （熔断器） </li>
<li>Global locks （全局锁） </li>
<li>Leadership election and cluster state （ 选举与集群状态管理） </li>
<li>Distributed messaging （分布式消息传递平台）</li>
</ul>
<p><strong>Spring Cloud 核心组件</strong></p>
<p>Spring Cloud 生态圈中的组件，按照发展可以分为第一代 Spring Cloud组件和第二代 Spring Cloud组件。</p>
<table>
<thead>
<tr>
<th></th>
<th>第一代 Spring Cloud（Netflix，SCN）</th>
<th>第二代 Spring Cloud（主要就是SpringCloud Alibaba，SCA）</th>
</tr>
</thead>
<tbody><tr>
<td>注册中心</td>
<td>Netflix Eureka</td>
<td>阿里巴巴 Nacos</td>
</tr>
<tr>
<td>客户端负载均衡</td>
<td>Netflix Ribbon</td>
<td>阿里巴巴 Dubbo LB、Spring Cloud Loadbalancer</td>
</tr>
<tr>
<td>熔断器</td>
<td>Netflix Hystrix</td>
<td>阿里巴巴 Sentinel</td>
</tr>
<tr>
<td>网关</td>
<td>Netflix Zuul：性能一般，未来将退出Spring Cloud 生态圈</td>
<td>官方 Spring Cloud Gateway</td>
</tr>
<tr>
<td>配置中心</td>
<td>官方 Spring Cloud Config</td>
<td>阿里巴巴 Nacos、携程 Apollo</td>
</tr>
<tr>
<td>服务调用</td>
<td>Netflix Feign</td>
<td>阿里巴巴 Dubbo RPC</td>
</tr>
<tr>
<td>消息驱动</td>
<td>官方 Spring Cloud Stream</td>
<td></td>
</tr>
<tr>
<td>链路追踪</td>
<td>官方 Spring Cloud Sleuth/Zipkin</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>阿里巴巴 seata 分布式事务方案</td>
</tr>
</tbody></table>
<p><strong>Spring Cloud 体系结构（组件协同工作机制）</strong></p>
<p>Spring Cloud中的各组件协同工作，才能够支持一个完整的微服务架构</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AmSe0"><img src="https://z3.ax1x.com/2021/09/14/4AmSe0.png" alt="4AmSe0.png"></a></p>
<p><strong>Spring Cloud 与 Dubbo 对比</strong> </p>
<p>Dubbo是阿里巴巴公司开源的一个高性能优秀的服务框架，基于RPC调用，对于目前使用率较高的 Spring Cloud Netflix来说，它是基于HTTP的，所以效率上没有Dubbo高。但问题在于Dubbo体系的组 件不全，不能够提供一站式解决方案，比如服务注册与发现需要借助于Zookeeper等实现，而Spring Cloud Netflix则是真正的提供了一站式服务化解决方案，且有Spring大家族背景。</p>
<p>前些年，Dubbo使用率高于SpringCloud，但目前Spring Cloud在服务化/微服务解决方案中已经有 了非常好的发展趋势。</p>
<p><strong>Spring Cloud 与 Spring Boot 的关系</strong></p>
<p>Spring Cloud 只是利用了Spring Boot 的特点，让我们能够快速的实现微服务组件开发，否则不使 用Spring Boot的话，我们在使用Spring Cloud时，每一个组件的相关Jar包都需要我们自己导入配置以 及需要开发人员考虑兼容性等各种情况。所以Spring Boot是我们快速把Spring Cloud微服务技术应用起 来的一种方式。</p>
<h1 id="准备案例"><a href="#准备案例" class="headerlink" title="准备案例"></a>准备案例</h1><p>本部分我们按照普通方式模拟一个微服务之间的调用，后续我们将一步步使用Spring Cloud的组件对案 例进行改造</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AWbrD"><img src="https://z3.ax1x.com/2021/09/14/4AWbrD.png" alt="4AWbrD.png"></a></p>
<p>基于SpringBoot来构造工程环境，工程模块关系如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AWjIA"><img src="https://z3.ax1x.com/2021/09/14/4AWjIA.png" alt="4AWjIA.png"></a></p>
<p><strong>数据库环境准备</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#商品信息表</span><br><span class="line">CREATE TABLE products(</span><br><span class="line">    id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    NAME VARCHAR(50), #商品名称</span><br><span class="line">    price DOUBLE,</span><br><span class="line">    flag VARCHAR(2), #上架状态</span><br><span class="line">    goods_desc VARCHAR(100), #商品描述</span><br><span class="line">    images VARCHAR(400), #商品图片</span><br><span class="line">    goods_stock INT, #商品库存</span><br><span class="line">    goods_type VARCHAR(20) #商品类型</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="父工程"><a href="#父工程" class="headerlink" title="父工程"></a>父工程</h2><p>idea中创建一个普通maven工程，命名为 spring-parent</p>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--父工程打包方式--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--spring boot 父启动器依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日志依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--测试依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok工具--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Actuator可以帮助你监控和管理Spring Boot应用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--编译插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--打包插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="公共组件微服务"><a href="#公共组件微服务" class="headerlink" title="公共组件微服务"></a>公共组件微服务</h2><p>父工程下创建子模块   spring-service-common</p>
<p><strong>pom.xml</strong></p>
<p>主要引入数据库驱动及mybatis-plus</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--pojo持久化使用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.persistence<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.persistence-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>生成数据库实体类：Products</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Table(name = &quot;products&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Products</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> price;</span><br><span class="line">    <span class="keyword">private</span> String flag;</span><br><span class="line">    <span class="keyword">private</span> String goodsDesc;</span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> goodsStock;</span><br><span class="line">    <span class="keyword">private</span> String goodsType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="商品微服务"><a href="#商品微服务" class="headerlink" title="商品微服务"></a>商品微服务</h2><p>商品微服务是服务提供者，父工程下创建模块  spring-service-product</p>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入公共组件微服务--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lagou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-service-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>application.yml 配置端口、应用名、数据库连接等信息</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">9001</span>  <span class="comment"># 后期该微服务会有多个实例</span></span><br><span class="line"><span class="attr">Spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">spring-service-product</span></span><br><span class="line"><span class="attr">datasource:</span></span><br><span class="line">	<span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">	<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/spring_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">	<span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">	<span class="attr">password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure>
<p><strong>mapper接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 现在使用的Mybatis-plus组件，该组件是Mybatis的加强版</span></span><br><span class="line"><span class="comment">    * 具体使用：让具体的Mapper接口继承BaseMapper即可,自动提供一些简单的CRUD</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Products</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>service层</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据id获取商品</span></span><br><span class="line">    <span class="function">Products <span class="title">getProductById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Products <span class="title">getProductById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Products <span class="title">query</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hui.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProductApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="页面静态微服务"><a href="#页面静态微服务" class="headerlink" title="页面静态微服务"></a>页面静态微服务</h2><p>页面静态微服务是服务消费者，父工程下创建模块  spring-service-page</p>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入公共组件微服务--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lagou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lagou-service-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>application.yml 配置端口、应用名、数据库连接等信息</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">9101</span> </span><br><span class="line"><span class="attr">Spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">spring-service-page</span></span><br><span class="line"><span class="attr">datasource:</span></span><br><span class="line">	<span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">	<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/spring_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">	<span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">	<span class="attr">password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure>
<p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/page&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用RestTemplate发送url调用远程服务</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Products <span class="title">findDataById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span>&#123;</span><br><span class="line">        String url =<span class="string">&quot;http://localhost:9001/product/get/&quot;</span>;</span><br><span class="line">        Products products = restTemplate.getForObject(url+id,Products.class);</span><br><span class="line">        <span class="keyword">return</span> products;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>启动类，注入RestTemplate</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PageApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="案例代码问题"><a href="#案例代码问题" class="headerlink" title="案例代码问题"></a>案例代码问题</h2><p>我们在页面静态化微服务中使用RestTemplate调用商品微服务的商品状态接口时（Restful API 接 口）。在微服务分布式集群环境下会存在什么问题呢?</p>
<p><strong>存在的问题及SpringCloud解决方案:</strong></p>
<ul>
<li>在服务消费者中，我们把url地址硬编码到代码中，不方便后期维护<ul>
<li>自动注册与发现</li>
</ul>
</li>
<li>在服务消费者中，不清楚服务提供者的状态。<ul>
<li>状态监管</li>
</ul>
</li>
<li>服务提供者只有一个服务，即便服务提供者形成集群，服务消费者还需要自己实现负载均衡<ul>
<li>服务负载均衡</li>
</ul>
</li>
<li>服务消费者调用服务提供者时候，如果出现故障能否及时发现不向用户抛出异常页面<ul>
<li>熔断</li>
</ul>
</li>
<li>RestTemplate这种请求调用方式是否还有优化空间？能不能类似于Dubbo那样玩<ul>
<li>远程过程调用</li>
</ul>
</li>
<li>这么多的微服务统一认证如何实现<ul>
<li>统一认证、网关拦截、路由转发</li>
</ul>
</li>
<li>配置文件每次都修改好多个很麻烦<ul>
<li>集中式配置管理，配置信息实时自动更新</li>
</ul>
</li>
</ul>
<h1 id="第一代核心组件SCN"><a href="#第一代核心组件SCN" class="headerlink" title="第一代核心组件SCN"></a>第一代核心组件SCN</h1><p>第一代网关组件Zuul性能一般，未来将退出Spring Cloud 生态圈，所以这里把GateWay划分到第一代Spring Cloud 核心组件这一部分，代替Zuul。</p>
<p><strong>各组件整体结构如下</strong></p>
<p>从形式上来说，Feign一个顶三，集成了相关组件，Feign = RestTemplate + Ribbon + Hystrix</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AX7bn"><img src="https://z3.ax1x.com/2021/09/14/4AX7bn.png" alt="4AX7bn.png"></a></p>
<h2 id="Eureka服务注册中心"><a href="#Eureka服务注册中心" class="headerlink" title="Eureka服务注册中心"></a>Eureka服务注册中心</h2><p>常用的服务注册中心：Eureka、Nacos、Zookeeper、Consul</p>
<h3 id="服务注册中心相关概念"><a href="#服务注册中心相关概念" class="headerlink" title="服务注册中心相关概念"></a>服务注册中心相关概念</h3><p>服务注册中心本质上是为了解耦服务提供者和服务消费者</p>
<ul>
<li>没有注册中心：服务消费者 –&gt; 服务提供者</li>
<li>有了注册中心：服务消费者 –&gt; 服务注册中心 –&gt; 服务提供者</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4AxnAI"><img src="https://z3.ax1x.com/2021/09/14/4AxnAI.png" alt="4AxnAI.png"></a></p>
<p>分布式微服务架构中，服务注册中心用于存储服务提供者地址信息、服务发布相关的属性信息，消 费者通过主动查询和被动通知的方式获取服务提供者的地址信息，而不再需要通过硬编码方式得到提供 者的地址信息。消费者只需要知道当前系统发布了那些服务，而不需要知道服务具体存在于什么位置， 这就是<strong>透明化路由</strong>。</p>
<ol>
<li>启动服务提供者 </li>
<li>服务提供者将相关服务信息主动注册到注册中心 </li>
<li>启动服务消费者，获取服务注册信息： <ul>
<li>pull模式：服务消费者可以主动拉取可用的服务提供者清单 </li>
<li>push模式：服务消费者订阅服务（当服务提供者有变化时，注册中心也会主动推送更新后的 服务清单给消费者 </li>
</ul>
</li>
<li>服务消费者直接调用服务提供者 另外，注册中心也需要完成服务提供者的健康监控，当发现服务提供者失效时需要及时剔除；</li>
</ol>
<p><strong>主流注册中心</strong></p>
<table>
<thead>
<tr>
<th>组件名</th>
<th>语言</th>
<th>CAP</th>
<th>对外暴露接口</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP（自我保护机制，保证可用）</td>
<td>HTTP</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>HTTP/DNS</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>客户端</td>
</tr>
<tr>
<td>Nacos</td>
<td>Java</td>
<td>支持AP/CP切换</td>
<td>HTTP</td>
</tr>
</tbody></table>
<p><strong>CAP原则</strong></p>
<ul>
<li>P：分区容错性：分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用 性的服务（一定的要满足的） </li>
<li>C：数据一致性：all nodes see the same data at the same time </li>
<li>A：高可用：Reads and writes always succeed</li>
</ul>
<p>CAP不可能同时满足三个，要么是AP，要么是CP</p>
<h3 id="Eureka相关概念"><a href="#Eureka相关概念" class="headerlink" title="Eureka相关概念"></a>Eureka相关概念</h3><p>Eureka 包含两个组件：  <strong>Eureka Server</strong>   和   <strong>Eureka Client</strong>  </p>
<ul>
<li>Eureka Client是一个Java客户端，用于简化 与Eureka Server的交互；</li>
<li>Eureka Server提供服务发现的能力，各个微服务启动时，会通过Eureka Client向Eureka Server 进行注册自己的信息（例如网络信息），Eureka Server会存储该服务的信息</li>
</ul>
<p><strong>Eureka 基础架构</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ES8Ts"><img src="https://z3.ax1x.com/2021/09/14/4ES8Ts.png" alt="4ES8Ts.png"></a></p>
<p><strong>Eureka 集群架构</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4EScfx"><img src="https://z3.ax1x.com/2021/09/14/4EScfx.png" alt="4EScfx.png"></a></p>
<ol>
<li>图中us-east-1c、us-east-1d，us-east-1e代表不同的区也就是不同的机，每一个Eureka Server都是一个集群。</li>
<li>图中Application Service作为服务提供者向Eureka Server中注册服务，Eureka Server接受到注 册事件会在集群和分区中进行数据同步，Application Client作为消费端（服务消费者）可以从Eureka Server中获取到服务注册信息，进行服务调用。</li>
<li>微服务启动后，会周期性地向Eureka Server发送心跳（默认周期为<strong>30秒</strong>）以续约自己的信息</li>
<li>Eureka Server在一定时间内没有接收到某个微服务节点的心跳，Eureka Server将会注销该微 服务节点（默认<strong>90秒</strong>）</li>
<li>每个Eureka Server同时也是Eureka Client，多个Eureka Server之间通过复制的方式完成服务 注册列表的同步</li>
<li>Eureka Client会缓存Eureka Server中的信息。即使所有的Eureka Server节点都宕掉，服务消 费者依然可以使用缓存中的信息找到服务提供者 </li>
</ol>
<p>Eureka通过心跳检测、健康检查和客户端缓存等机制，提高系统的灵活性、可伸缩性和高可用性。</p>
<h3 id="搭建单例Eureka-Server服务注册中心"><a href="#搭建单例Eureka-Server服务注册中心" class="headerlink" title="搭建单例Eureka Server服务注册中心"></a>搭建单例Eureka Server服务注册中心</h3><p><strong>实现过程</strong>：</p>
<ol>
<li>单例Eureka Server—&gt;访问管理界面 </li>
<li>服务提供者（商品微服务注册到集群） </li>
<li>服务消费者（页面静态化微服务注册到Eureka/从Eureka Server获取服务信息） </li>
<li>完成调用</li>
</ol>
<h4 id="搭建单例Eureka-Server"><a href="#搭建单例Eureka-Server" class="headerlink" title="搭建单例Eureka Server"></a>搭建单例Eureka Server</h4><p><strong>spring-parent中引入Spring Cloud依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Cloud 是一个综合的项目，下面有很多子项目，比如eureka子项目--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：在父工程的pom文件中手动引入jaxb的jar，因为Jdk9之后默认没有加载该模块，Eureka Server使用到，所以需要手动导入，否则EurekaServer服务无法启动</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入Jaxb，开始--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10-b140310.1920<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入Jaxb，结束--&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>创建子模块spring-cloud-eureka，并引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Eureka server依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>配置application.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-eureka</span></span><br><span class="line"><span class="comment"># eureka相关配置    </span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># 客户端与EurekaServer交互的地址，如果是集群，也需要写其它Server的地址，当前是自己</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>   <span class="comment"># 向集群中注册自己，默认true（单例模式没必要）</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>         <span class="comment">#Eureka Server获取服务信息,默认为true （单例模式没必要）</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>
<p><strong>编写启动类，声明当前服务为Eureka注册中心</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span> <span class="comment">// 标识该项目为一个Eureka Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动项目，访问<a href="http://127.0.0.1:9201，如果看到Eureka注册中心后台，则表明EurekaServer">http://127.0.0.1:9201，如果看到Eureka注册中心后台，则表明EurekaServer</a> 发布成功</p>
<h4 id="服务提供者注册到注册中心"><a href="#服务提供者注册到注册中心" class="headerlink" title="服务提供者注册到注册中心"></a>服务提供者注册到注册中心</h4><p><strong>spring-service-product引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Eureka client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>yml配置Eureka服务端信息</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span>  <span class="comment">#  eureka server的路径</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:9201/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#使用ip注册，否则会使用主机名注册了（此处考虑到对老版本的兼容，新版本经过实验都是ip）</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#自定义实例显示格式，加上版本号，便于多版本管理，注意是ip-address，早期版本是ipAddress</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;:@project.version@</span></span><br></pre></td></tr></table></figure>
<p><strong>修改启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hui.mapper&quot;)</span></span><br><span class="line"><span class="comment">//@EnableEurekaClient  // 表示当前项目注册到 Eureka Server</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>   <span class="comment">// 表示当前项目注册到注册中心（包含Eureka、zookeeper等）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProductApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务消费者注册到注册中心"><a href="#服务消费者注册到注册中心" class="headerlink" title="服务消费者注册到注册中心"></a>服务消费者注册到注册中心</h4><p>与上面步骤一样，对于EurekaServer来说，服务提供者与服务消费者都是EurekaClient角色。</p>
<h4 id="完成调用"><a href="#完成调用" class="headerlink" title="完成调用"></a>完成调用</h4><p>之前消费方调用提供方，是通过RestTemplate硬编码的方式调用url，现在我们可以小小的改变一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Eureka注册中心容器</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;get/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Products <span class="title">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从Eureka注册中心获取的 spring-service-product 实例集合</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instanceList = discoveryClient.getInstances(<span class="string">&quot;spring-service-product&quot;</span>);</span><br><span class="line">    ServiceInstance instance = instanceList.get(<span class="number">0</span>);<span class="comment">// 当前不是集群环境，所以只有一个</span></span><br><span class="line">    <span class="comment">// 从实例中获取ip与端口号</span></span><br><span class="line">    String host = instance.getHost();</span><br><span class="line">    <span class="keyword">int</span> port = instance.getPort();</span><br><span class="line">    <span class="comment">// 获取消费提供方的ip与端口经行拼接URL</span></span><br><span class="line">    String url = <span class="string">&quot;http://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port + <span class="string">&quot;/product/get/&quot;</span>; </span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(url + id, Products.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="搭建Eureka-Server-高可用集群"><a href="#搭建Eureka-Server-高可用集群" class="headerlink" title="搭建Eureka Server 高可用集群"></a>搭建Eureka Server 高可用集群</h3><p>在互联网应用中，服务实例很少有单个的。 在生产环境中，我们会配置Eureka Server集群实现高可用。Eureka Server集群之中的节点通过点 对点（P2P）通信的方式共享服务注册表。我们开启两台 Eureka Server 以搭建集群。 </p>
<p>由于是在个人计算机中进行测试很难模拟多主机的情况，Eureka配置server集群时需要执行host地 址。 所以需要修改个人电脑中host地址，win10操作系统下：<strong>C:\Windows\System32\drivers\etc\host</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 测试Eureka集群</span><br><span class="line">127.0.0.1  EurekaServerA</span><br><span class="line">127.0.0.1  EurekaServerB</span><br></pre></td></tr></table></figure>
<p>将spring-cloud-eureka复制一份为spring-cloud-eureka02</p>
<p><strong>修改 Eureka Server配置文件</strong></p>
<p>9201</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-eureka</span> <span class="comment"># 应用名称，会在Eureka中作为id表示，同一集群要相同</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">EurekaServerA</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># 客户端与EurekaServer交互的地址，如果是集群，也需要写其它Server的地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://EurekaServerB:9202/eureka/</span>  <span class="comment"># 另一个集群地址</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>   <span class="comment"># 向集群中注册自己，默认true（单例模式没必要）</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>         <span class="comment">#Eureka Server获取服务信息,默认为true （单例模式没必要）</span></span><br></pre></td></tr></table></figure>
<p>9202</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9202</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">EurekaServerB</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://EurekaServerA:9201/eureka/</span>  <span class="comment"># 另一个集群地址</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>修改商品微服务eureka配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span>  <span class="comment">#  eureka server的路径，添加集群</span></span><br><span class="line">      <span class="comment">#把 eureka 集群中的所有 url 都填写了进来，也可以只写一台，因为各个 eureka server可以同步注册表</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://EurekaServerA:9201/eureka/,http://EurekaServerB:9202/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#使用ip注册，否则会使用主机名注册了（此处考虑到对老版本的兼容，新版本经过实验都是ip）</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#自定义实例显示格式，加上版本号，便于多版本管理，注意是ip-address，早期版本是ipAddress</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;:@project.version@</span></span><br></pre></td></tr></table></figure>
<p><strong>修改页面静态微服务</strong></p>
<p>同上。</p>
<p>调用方法与单例Eureka Server一样。</p>
<h3 id="Eureka细节详情"><a href="#Eureka细节详情" class="headerlink" title="Eureka细节详情"></a>Eureka细节详情</h3><h4 id="Eureka元数据"><a href="#Eureka元数据" class="headerlink" title="Eureka元数据"></a>Eureka元数据</h4><p>Eureka的元数据有两种：标准元数据和自定义元数据。 </p>
<ul>
<li>标准元数据：主机名、IP地址、端口号等信息，这些信息都会被发布在服务注册表中，用于服务之 间的调用。 </li>
<li>自定义元数据：可以使用eureka.instance.metadata-map配置，符合KEY/VALUE的存储格式。这 些元数据可以在远程客户端中访问。</li>
</ul>
<p>例如在商品微服务中定义自定义元数据</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">instance:</span></span><br><span class="line">        <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ipaddress&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;:@project.version@</span></span><br><span class="line">        <span class="attr">metadata-map:</span></span><br><span class="line">            <span class="attr">ip:</span> <span class="number">11.11</span><span class="number">.11</span><span class="number">.11</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">10000</span></span><br><span class="line">            <span class="attr">user:</span> <span class="string">oddDog</span></span><br><span class="line">            <span class="attr">pwd:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>在页面微服务中获取商品微服务自定义元数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;metadata&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetadataController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>   <span class="comment">// Eureka注册中心容器</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;show&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showMetadata</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;spring-service-product&quot;</span>);</span><br><span class="line">        ServiceInstance instance = instanceList.get(<span class="number">0</span>);<span class="comment">// 当前不是集群环境，所以只有一个</span></span><br><span class="line">        <span class="comment">//获取服务元数据</span></span><br><span class="line">        Map&lt;String, String&gt; metadata = instance.getMetadata();</span><br><span class="line">        <span class="keyword">for</span> (String key : metadata.entrySet())&#123;</span><br><span class="line">            System.out.println(key+<span class="string">&quot;:&quot;</span>+metadata.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Eureka客户端详情"><a href="#Eureka客户端详情" class="headerlink" title="Eureka客户端详情"></a>Eureka客户端详情</h4><ol>
<li>当我们导入了eureka-client依赖坐标，配置Eureka服务注册中心地址 </li>
<li>服务在启动时会向注册中心发起注册请求，携带服务元数据信息</li>
<li>Eureka注册中心会把服务的信息保存在Map中。</li>
</ol>
<p><strong>服务续约详解（客户端)</strong></p>
<p>客户端每隔30秒会向注册中心续约(心跳)一次（也称为报活），如果没有续约，租约在90秒后到期， 然后服务会被失效。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#客户端设置续约，默认即可</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">instance:</span></span><br><span class="line">        <span class="comment"># 租约续约间隔时间，默认30秒</span></span><br><span class="line">        <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="comment"># 租约到期，服务时效时间，默认值90秒,服务超过90秒没有发生心跳，EurekaServer会将服务从列表移除</span></span><br><span class="line">		<span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">90</span></span><br></pre></td></tr></table></figure>
<p><strong>客户端获取服务列表</strong></p>
<ol>
<li>服务消费者启动时，从 EurekaServer服务列表获取只读备份，缓存到本地</li>
<li>每隔30秒，会重新获取并更新数据, 可以通过配置修改。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#客户端设置拉去服务列表时间，默认即可</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">client:</span></span><br><span class="line">        <span class="comment"># 每隔多久拉取一次服务列表</span></span><br><span class="line">        <span class="attr">registry-fetch-interval-seconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<h4 id="Eureka服务端详情"><a href="#Eureka服务端详情" class="headerlink" title="Eureka服务端详情"></a>Eureka服务端详情</h4><p><strong>服务下线</strong></p>
<ol>
<li>当服务正常关闭操作时，会发送服务下线的REST请求给EurekaServer。</li>
<li>服务中心接受到请求后，将该服务置为下线状态</li>
</ol>
<p><strong>自我保护机制</strong></p>
<p>如果在15分钟内超过85%的客户端节点都没有正常的心跳，那么 Eureka就认为客户端与注册中心出现了网络故障，Eureka Server自动进入自我保护机制,此时会出现 以下几种情况：</p>
<ol>
<li>Eureka Server不再从注册列表中移除因为长时间没收到心跳而应该过期的服务。 </li>
<li>Eureka Server仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上，保证当前 节点依然可用。 </li>
<li>当网络稳定时，当前Eureka Server新的注册信息会被同步到其它节点中。</li>
</ol>
<p>因此Eureka Server可以很好的应对因网络故障导致部分节点失联的情况，而不会像ZK那样如果有一半 不可用的情况会导致整个集群不可用而变成瘫痪。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务端设置自我保护模式，默认开启，建议开启</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">server:</span></span><br><span class="line">		<span class="attr">enable-self-preservation:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h2><h3 id="负载均衡相关概念"><a href="#负载均衡相关概念" class="headerlink" title="负载均衡相关概念"></a>负载均衡相关概念</h3><p>负载均衡一般分为 服务器端负载均衡和客户端负载均衡</p>
<p><strong>服务器端负载均衡</strong> ： 比如Nginx、F5这些，请求到达服务器之后由这些负载均衡器根据一定的 算法将请求路由到目标服务器处理。 </p>
<p><strong>客户端负载均衡</strong> ： 比如我们要说的Ribbon，服务消费者客户端会有一个服务器地址列表，调用 方在请求前通过一定的负载均衡算法选择一个服务器进行访问，负载均衡算法的执行是在请求客户端进 行。 </p>
<p>Ribbon是Netflix发布的负载均衡器。Eureka一般配合Ribbon进行使用，Ribbon利用从Eureka中读 取到服务信息，在调用服务提供者提供的服务时，会根据一定的算法进行负载。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VfpM6"><img src="https://z3.ax1x.com/2021/09/15/4VfpM6.png" alt="4VfpM6.png"></a></p>
<h3 id="Ribbon的使用"><a href="#Ribbon的使用" class="headerlink" title="Ribbon的使用"></a>Ribbon的使用</h3><p><strong>需求</strong>:  复制商品微服务spring-service-product02,修改端口:9002，在两个服务提供者中编写Controller方法，返回服务实例端口。服务消费者 spring-service-page 通过负载均衡策略调用该方法。</p>
<p>微服务中引入过eureka-client相关依赖，会自动引入 Ribbon相关依赖坐标，所以不需要导入Ribbon依赖</p>
<p><strong>服务提供方编写Controller,并复制一份微服务spring-service-product02</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前端口号请求</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;port&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>服务消费方注入RestTemplate时添加对应注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  <span class="comment">// 当前项目注册到注册中心</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PageApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  注入RestTemplate</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>  <span class="comment">// Ribbon 负载均衡</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>服务消费方调用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;port&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 直接通过服务的名称来访问，不需要指定ip与port  (注意：要开启Ribbon负载均衡)</span></span><br><span class="line">    String url = <span class="string">&quot;http://spring-service-product/product/port&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Ribbon负载均衡策略"><a href="#Ribbon负载均衡策略" class="headerlink" title="Ribbon负载均衡策略"></a>Ribbon负载均衡策略</h3><p>Ribbon内置了多种负载均衡策略，内部负责复杂均衡的顶级接口为 com.netflix.loadbalancer.IRule </p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4V5gln"><img src="https://z3.ax1x.com/2021/09/15/4V5gln.png" alt="4V5gln.png"></a></p>
<table>
<thead>
<tr>
<th>负载均衡策略</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>RoundRobinRule：轮询策略</td>
<td>默认超过10次获取到的server都不可用，会返回一个空的server</td>
</tr>
<tr>
<td>RandomRule：随机策略</td>
<td>如果随机到的server为null或者不可用的话，会while不停的循环选取</td>
</tr>
<tr>
<td>RetryRule：重试策略</td>
<td>一定时限内循环重试。默认继承RoundRobinRule，也支持自定义注入，RetryRule会在每次选取之后，对选举的server进行判断，是否为null，是否alive，并且在500ms内会不停的选取判断。而RoundRobinRule失效的策略是超过10次，RandomRule是没有失效时间的概念，只要serverList没都挂。</td>
</tr>
<tr>
<td>BestAvailableRule：最小连接数策略</td>
<td>遍历serverList，选取出可用的且连接数最小的一个server。该算法里面有一个LoadBalancerStats的成员变量，会存储所有server的运行状况和连接数。如果选取到的server为null，那么会调用RoundRobinRule重新选取。</td>
</tr>
<tr>
<td>AvailabilityFilteringRule： 可用过滤策略</td>
<td>扩展了轮询策略，会先通过默认的轮询选取一个server，再去判断该server是否超时可用，当前连接数是否超限，都成功再返回。</td>
</tr>
<tr>
<td>ZoneAvoidanceRule：区域权衡策略（默认策略）</td>
<td>扩展了轮询策略，继承了2个过滤器：ZoneAvoidancePredicate和AvailabilityPredicate，除了过滤超时和链接数过多的server，还会过滤掉不符合要求的zone区域里面的所有节点， 在一个区域/机房内的服务实例中轮询。先过滤再轮询</td>
</tr>
</tbody></table>
<p><strong>修改负载均衡策略</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#针对的被调用方微服务名称,不加就是全局生效</span></span><br><span class="line"><span class="attr">spring-service-product:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#随机策略</span></span><br></pre></td></tr></table></figure>
<h3 id="Ribbon源码剖析"><a href="#Ribbon源码剖析" class="headerlink" title="Ribbon源码剖析"></a>Ribbon源码剖析</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VI5ut"><img src="https://z3.ax1x.com/2021/09/15/4VI5ut.png" alt="4VI5ut.png"></a></p>
<p>SpringCloud充分利用了SpringBoot的自动装配特点，在spring-cloud-commons包中找spring.factories配置文件</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4V7eAK"><img src="https://z3.ax1x.com/2021/09/15/4V7eAK.png" alt="4V7eAK.png"></a></p>
<p>进入 LoadBalancerAutoConfiguration 类中</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VHEvj"><img src="https://z3.ax1x.com/2021/09/15/4VHEvj.png" alt="4VHEvj.png"></a></p>
<p><strong>注入RestTemplate拦截器</strong>： 为RestTemplate对象设置loadBalancerInterceptor</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VHjiT"><img src="https://z3.ax1x.com/2021/09/15/4VHjiT.png" alt="4VHjiT.png"></a></p>
<p>所以，添加了注解的RestTemplate对象会被添加一个拦截器LoadBalancerInterceptor， 该拦截器就是后续拦截请求进行负载处理的。</p>
<h2 id="Hystrix熔断器"><a href="#Hystrix熔断器" class="headerlink" title="Hystrix熔断器"></a>Hystrix熔断器</h2><p>属于一种容错机制</p>
<h3 id="服务雪崩相关概念"><a href="#服务雪崩相关概念" class="headerlink" title="服务雪崩相关概念"></a>服务雪崩相关概念</h3><p><strong>服务雪崩效应</strong>：是一种因“服务提供者的不可用”（原因）导致“服务调用者不可用”（结果），并将不可用逐渐放大，导致整个系统瘫痪。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VqP1g"><img src="https://z3.ax1x.com/2021/09/15/4VqP1g.png" alt="4VqP1g.png"></a></p>
<p>扇入大，说明该模块复用性好 ，扇出大，说明业务逻辑复杂 ；扇入大是一个好事，扇出大不一定是好事</p>
<p>最下游商品微服务响应时间过长，大量请求阻塞，大量线程不会释放，会导致服务器 资源耗尽，最终导致上游服务甚至整个系统瘫痪</p>
<p><strong>服务雪崩的过程可以分为三个阶段</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4VLMIP"><img src="https://z3.ax1x.com/2021/09/15/4VLMIP.png" alt="4VLMIP.png"></a></p>
<p><strong>雪崩效应解决方案</strong></p>
<ul>
<li>服务熔断<ul>
<li>熔断机制是应对雪崩效应的一种微服务链路保护机制，当扇出链路的某个微服务不可用或者响应时间太长时，熔断该节点微服务的调用，进行服务的降级，快速返回错误的响应信息。当检测到该节点微服务调用响应正常后，恢复调用链路。</li>
</ul>
</li>
<li>服务降级<ul>
<li>整体资源不够用了，先将一些不关紧的服务停掉（调用服务的时候，直接返回一个预留的 值，也叫做兜底数据），待渡过难关高峰过去，再把那些服务打开。</li>
</ul>
</li>
<li>服务限流<ul>
<li>限制总并发数（比如数据库连接池、线程池） </li>
<li>限制瞬时并发数（如nginx限制瞬时并发连接数） </li>
<li>限制时间窗口内的平均速率（如Guava的RateLimiter、nginx的limit_req模块，限制每秒的平均速 率） </li>
<li>限制远程接口调用速率、限制MQ的消费速率等</li>
</ul>
</li>
</ul>
<h3 id="Hystrix简介"><a href="#Hystrix简介" class="headerlink" title="Hystrix简介"></a>Hystrix简介</h3><p>Hystrix主 要通过以下几点实现延迟和容错。 </p>
<ul>
<li>包裹请求：使用@HystrixCommand包裹对依赖的调用逻辑。 </li>
<li>跳闸机制：当某服务的错误率超过一定的阈值时，Hystrix可以跳闸，停止请求该服务一段时间。 </li>
<li>资源隔离：Hystrix为每个依赖都维护了一个小型的线程池(舱壁模式)。如果该线程池已满， 发往该 依赖的请求就被立即拒绝，而不是排队等待，从而加速失败判定。 </li>
<li>监控：Hystrix可以近乎实时地监控运行指标和配置的变化，例如成功、失败、超时、以及被拒绝 的请求等。 </li>
<li>回退机制：当请求失败、超时、被拒绝，或当断路器打开时，执行回退逻辑。回退逻辑由开发人员 自行提供，例如返回一个缺省值。 </li>
<li>自我修复：断路器打开一段时间后，会自动进入“半开”状态（探测服务是否可用，如还是不可用， 再次退回打开状态）。</li>
</ul>
<h3 id="Hystrix的使用"><a href="#Hystrix的使用" class="headerlink" title="Hystrix的使用"></a>Hystrix的使用</h3><h4 id="熔断处理"><a href="#熔断处理" class="headerlink" title="熔断处理"></a>熔断处理</h4><p>需求：页面静态化微服务调用商品微服务，如果长时间没有响应，则页面静态化微服务快速失败给用户提示</p>
<p><strong>引入依赖</strong>   </p>
<p>服务消费者（静态化微服务）中引入Hystrix依赖（也可以添加在父工程中）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--熔断器Hystrix--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>开启熔断</strong></p>
<p>启动类中添加熔断器开启注解@EnableCircuitBreaker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注解简化写法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@SpringCloudApplication</span> =</span></span><br><span class="line"><span class="comment">    	<span class="doctag">@SpringBootApplication</span>+<span class="doctag">@EnableDiscoveryClient</span>+<span class="doctag">@EnableCircuitBreaker</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">//@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">// 开启熔断</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageApplication</span> </span>&#123;<span class="comment">// 省略&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>定义服务熔断处理方法</strong></p>
<p>配置@HystrixCommand注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用@HystrixCommand注解进行熔断控制</span></span><br><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    // 线程池标识，要保持唯一，不唯一的话就共用</span></span><br><span class="line"><span class="meta">    threadPoolKey = &quot;port&quot;,</span></span><br><span class="line"><span class="meta">    // 线程池细节属性配置</span></span><br><span class="line"><span class="meta">    threadPoolProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;coreSize&quot;, value = &quot;1&quot;), // 线程并发数</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;maxQueueSize&quot;, value = &quot;20&quot;) // 线程队列最大值，默认-1，不开启</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;queueSizeRejectionThreshold&quot;, value = &quot;15&quot;) //控制队列最大阈值,默认值5,达到该值后，请求也会被拒绝，需搭配 maxQueueSize 使用</span></span><br><span class="line"><span class="meta">    &#125;,</span></span><br><span class="line"><span class="meta">    // 熔断的一些细节属性配置</span></span><br><span class="line"><span class="meta">    commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        // 请求超时时间</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;2000&quot;),</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;port&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;http://spring-service-product/product/port&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可在 spring-service-product提供放的product/port方法上添加一Thread.Sleep() 来模拟超时操作 </p>
<h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><p>使用@HystrixCommand的fallbackMethod属性关联到服务降 级处理方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务降级</span></span><br><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        // 请求超时时间</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;2000&quot;) </span></span><br><span class="line"><span class="meta">    &#125;,</span></span><br><span class="line"><span class="meta">    fallbackMethod = &quot;fallBack&quot; // 服务降级调用方法</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;port2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">port2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;http://spring-service-product/product/port02&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务降级调用方法,该方法形参和返回值与原始方法保持一致</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">fallBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-1&quot;</span>; <span class="comment">// 返回兜底数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HysTrix舱壁模式</strong>     </p>
<p>如果不进行任何设置，添加了@HystrixCommand注解的所有熔断方法使用同一个Hystrix线程池（10个线程）,这样很容易导致线程不可以的问题。</p>
<p>为了避免问题服务请求过多导致正常服务无法访问，Hystrix 不是采用增加线程数，而是单独的为每一个 控制方法创建一个线程池的方式，这种模式叫做“舱壁模式”，也是线程隔离的手段。</p>
<p>我们只需要在@HystrixCommand里面设置  threadPoolKey 的值不唯一即可。</p>
<h3 id="Hystrix工作流程与高级应用"><a href="#Hystrix工作流程与高级应用" class="headerlink" title="Hystrix工作流程与高级应用"></a>Hystrix工作流程与高级应用</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4Zep1e"><img src="https://z3.ax1x.com/2021/09/15/4Zep1e.png" alt="4Zep1e.png"></a></p>
<p>1）当调用出现问题时，开启一个时间窗（10s） </p>
<p>2）在这个时间窗内，统计调用次数是否达到最小请求数？ </p>
<p>​        如果没有达到，则重置统计信息，回到第1步 如果达到了，则统计失败的请求数占所有请求数的百分比，是否达到阈值？</p>
<p>​        如果达到，则跳闸（不再请求对应服务） 如果没有达到，则重置统计信息，回到第1步 </p>
<p>3）如果跳闸，则会开启一个活动窗口（默认5s），每隔5s，Hystrix会让一个请求通过,到达那个问题服 务，看是否调用成功，如果成功，重置断路器回到第1步，如果失败，回到第3步</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 8秒钟内，请求次数达到2个，并且失败率在50%以上，就跳闸</span></span><br><span class="line"><span class="comment">* 跳闸后活动窗口设置为3s</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">    commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        //统计窗口时间的设置</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name =</span></span><br><span class="line"><span class="meta">                         &quot;metrics.rollingStats.timeInMilliseconds&quot;,value = &quot;8000&quot;),</span></span><br><span class="line"><span class="meta">        //统计窗口内的最小请求数</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name =</span></span><br><span class="line"><span class="meta">                         &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;2&quot;),</span></span><br><span class="line"><span class="meta">        //统计窗口内错误请求阈值的设置 50%</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name =</span></span><br><span class="line"><span class="meta">                         &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;50&quot;),</span></span><br><span class="line"><span class="meta">        //自我修复的活动窗口时间</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name =</span></span><br><span class="line"><span class="meta">                         &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>
<p><strong>以上的所有配在也可以在配置文件中完成</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置熔断策略：</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">	<span class="comment"># 连接池设置</span></span><br><span class="line">    <span class="attr">threadpool:</span></span><br><span class="line">        <span class="attr">default:</span></span><br><span class="line">            <span class="attr">coreSize:</span> <span class="number">10</span> <span class="comment">#并发执行的最大线程数，默认10</span></span><br><span class="line">            <span class="attr">maxQueueSize:</span> <span class="number">1000</span> <span class="comment">#BlockingQueue的最大队列数，默认值-1</span></span><br><span class="line">            <span class="attr">queueSizeRejectionThreshold:</span> <span class="number">800</span> <span class="comment">#即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝，默认值5</span></span><br><span class="line">    <span class="comment"># 命令设置        </span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">        <span class="attr">default:</span></span><br><span class="line">            <span class="attr">circuitBreaker:</span></span><br><span class="line">            	<span class="comment"># 强制打开熔断器，如果该属性设置为true，强制断路器进入打开状态，将会拒绝所有的请求。默认false关闭的</span></span><br><span class="line">                <span class="attr">forceOpen:</span> <span class="literal">false</span></span><br><span class="line">                <span class="comment"># 熔断触发最小请求次数，默认值是20</span></span><br><span class="line">            	<span class="attr">requestVolumeThreshold:</span> <span class="number">2</span></span><br><span class="line">                <span class="comment"># 触发熔断错误比例阈值，默认值50%</span></span><br><span class="line">                <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span></span><br><span class="line">                <span class="comment"># 熔断后休眠时长，默认值5秒</span></span><br><span class="line">                <span class="attr">sleepWindowInMilliseconds:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">execution:</span></span><br><span class="line">            	<span class="attr">isolation:</span></span><br><span class="line">            		<span class="attr">thread:</span></span><br><span class="line">                        <span class="comment"># 熔断超时设置，默认为1秒</span></span><br><span class="line">                        <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<p>基于springboot的健康检查观察跳闸状态（自动投递微服务暴露健康检查细节）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># springboot中暴露健康检查等断点接口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">    <span class="attr">endpoints:</span></span><br><span class="line">        <span class="attr">web:</span></span><br><span class="line">        	<span class="attr">exposure:</span></span><br><span class="line">        		<span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="comment"># 暴露健康接口的细节</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">        <span class="attr">health:</span></span><br><span class="line">        	<span class="attr">show-details:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure>
<p>访问健康检查接口：<a target="_blank" rel="noopener" href="http://localhost:9100/actuator/health">http://localhost:9100/actuator/health</a></p>
<h2 id="Feign服务调用"><a href="#Feign服务调用" class="headerlink" title="Feign服务调用"></a>Feign服务调用</h2><p>Feign是Netflix开发的一个轻量级RESTful的HTTP服务客户端（用它来发起请求，远程调用），是以Java  <strong>接口注解</strong>  的方式调用Http请求，而不用像之前的RestTemplate技术中通过  <strong>封装HTTP请求报文</strong>  的方式直接调用， Feign被广泛应用在Spring Cloud 的解决方案中。 </p>
<ul>
<li><p>类似于Dubbo，服务消费者拿到服务提供者的接口，然后像调用本地接口方法一样去调用，实际发 出的是远程的请求。 </p>
</li>
<li><p>Feign可帮助我们更加便捷、优雅的调用HTTP API，SpringCloud对Feign进行了增强，使Feign支持了SpringMVC注解（OpenFeign）</p>
</li>
</ul>
<p><strong>效果</strong>：Feign = RestTemplate+Ribbon+Hystrix</p>
<h3 id="Feign的使用"><a href="#Feign的使用" class="headerlink" title="Feign的使用"></a>Feign的使用</h3><p><strong>引入依赖</strong></p>
<p>服务消费者（页面静态化微服务）中引入Feign依赖（或者父类工程）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>启动类开启Feign的支持</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  <span class="comment">// 当前项目注册到注册中心</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">//  开启Feign，需取消开启熔断，feign自动集成了熔断</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PageApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>  去掉Hystrix熔断的支持注解@EnableCircuitBreaker，包括引入的依赖，因为Feign会自动引入，而且RestTemplate也不需要注入。</p>
<p><strong>在消费者微服务中创建Feign接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name表示调用哪一个服务，唯一，所以一个模块的所有controller方法都要定义带该类中</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;spring-service-product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">Products <span class="title">getProductById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前端口号请求</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/port&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">port</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<p> 1）@FeignClient注解的name属性用于指定要调用的服务提供者名称，和服务提供者yml文件中 spring.application.name保持一致 </p>
<p>2）接口中的接口方法，就好比是远程服务提供者Controller中的Hander方法，可以使用@PathVariable、@RequestParam、@RequestHeader 等，这也是OpenFeign对SpringMVC注解的支持，但是需要注意value必须设置，否则会抛出异常 </p>
<ol start="3">
<li>@FeignClient(name = “lagou-service-product”)，name在消费者微服务中只能出现一次，否则报错。所以最好将调用一个 微服务的信息都定义在一个Feign接口中。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># @FeignClient(name = &quot;spring-service-product&quot;)只能注册一次，如果在同一个项目集群中出现多次，则会报错，续添加配置解决</span></span><br><span class="line"><span class="comment">#解决bean重复注册问题</span></span><br><span class="line"><span class="attr">Spring:</span></span><br><span class="line">    <span class="attr">main:</span></span><br><span class="line">    	<span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>改造PageController中原有的调用方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;page&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Feign接口</span></span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> ProductFeign productFeign;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用feign调用远程服务</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;queryById/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Products <span class="title">queryById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productFeign.getProductById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;getPort&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productFeign.port();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Feign对负载均衡的支持"><a href="#Feign对负载均衡的支持" class="headerlink" title="Feign对负载均衡的支持"></a>Feign对负载均衡的支持</h3><p>Feign 本身已经集成了Ribbon依赖和自动配置，因此我们不需要额外引入依赖</p>
<p>Feign默认的请求处理超时时长<strong>1s</strong>，有时候我们的业务确实执行的需要一定时间，我们就 需要调整请求处理超时时长，Feign自己有超时设置，如果配置Ribbon的超时，则会以Ribbon的为准。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#针对的被调用方微服务名称,不加就是全局生效</span></span><br><span class="line"><span class="attr">lagou-service-product:</span></span><br><span class="line">    <span class="attr">ribbon:</span></span><br><span class="line">        <span class="comment">#请求连接超时时间</span></span><br><span class="line">        <span class="attr">ConnectTimeout:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment">#请求处理超时时间</span></span><br><span class="line">        <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment">#对所有操作都进行重试</span></span><br><span class="line">        <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment">####根据如上配置，当访问到故障请求的时候，它会再尝试访问一次当前实例（次数由MaxAutoRetries配置），</span></span><br><span class="line">        <span class="comment">####如果不行，就换一个实例进行访问，如果还不行，再换一次实例访问（更换次数由MaxAutoRetriesNextServer配置），</span></span><br><span class="line">        <span class="comment">####如果依然不行，返回失败信息。</span></span><br><span class="line">        <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#对当前选中实例重试次数，不包括第一次调用</span></span><br><span class="line">        <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">0</span> <span class="comment">#切换实例的重试次数</span></span><br><span class="line">        <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RoundRobinRule</span> <span class="comment">#负载策略调整</span></span><br></pre></td></tr></table></figure>
<h3 id="Feign对熔断器的支持"><a href="#Feign对熔断器的支持" class="headerlink" title="Feign对熔断器的支持"></a>Feign对熔断器的支持</h3><p><strong>在Feign客户端工程配置文件中需开启Feign对熔断器的支持</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启Feign的熔断功能</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">	<span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol>
<li>开启Hystrix之后，Feign中的方法都会被进行一个管理了，一旦出现问题就进入对应的回退逻辑处理 </li>
<li>针对超时这一点，当前有两个超时时间设置（Feign/hystrix），熔断的时候是根据这两个时间的最小 值来进行的</li>
</ol>
<p>hystrix设置设置时长请参考上面代码。</p>
<p><strong>自定义FallBack处理类(需要实现刚刚编写的Feign接口)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductFeignFallback</span> <span class="keyword">implements</span> <span class="title">ProductFeign</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Products <span class="title">getProductById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;999999999999999999&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Feign接口中的@FeignClient注解要声明fallback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;lagou-service-product&quot;,fallback =ProductFeignFallBack.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductFeign</span> </span>&#123;<span class="comment">/*省略*/</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Feign对请求压缩和响应压缩的支持"><a href="#Feign对请求压缩和响应压缩的支持" class="headerlink" title="Feign对请求压缩和响应压缩的支持"></a>Feign对请求压缩和响应压缩的支持</h3><p>Feign 支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启feign的熔断功能</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 开启请求响应压缩</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span>  <span class="comment"># 设置压缩的数据类型，此处也是默认值</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span>  <span class="comment"># 设置触发压缩的大小下限，此处也是默认值</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>


<h2 id="Gateway网关"><a href="#Gateway网关" class="headerlink" title="Gateway网关"></a>Gateway网关</h2><p><strong>网关</strong>：微服务架构中的重要组成部分 局域网中就有网关这个概念，局域网接收或者发送数据出去通过这个网关，比如用Vmware虚拟机 软件搭建虚拟机集群的时候，往往我们需要选择IP段中的一个IP作为网关地址。 而Spring Cloud GateWay只是众多网关解决方案中的一种</p>
<p><strong>网关分类</strong>：</p>
<ul>
<li><p>全局网关 ：全局性质，跟具体的后端业务没有任何关系。如 Nginx + Lua语言</p>
<ul>
<li>功能 : 全局性流控、日志统计（ELK）、防止SQL注入、防止WEB攻击（OWASP十大web应用漏洞）、屏蔽工具扫描、IP黑白名单、证书/加解密处理</li>
</ul>
</li>
<li><p>业务网关 ：针对具体的后端业务系统。如 Zuul、Zuul2、Spring Cloud Gateway</p>
<ul>
<li>功能 : 服务界别流控、服务熔断、降级、路由、负载均衡、灰度策略、过滤、聚合、发现（Eureka）、权限验证、用户等级、业务规则、参数、缓存。</li>
</ul>
</li>
</ul>
<h3 id="GateWay相关概念"><a href="#GateWay相关概念" class="headerlink" title="GateWay相关概念"></a>GateWay相关概念</h3><p>Spring Cloud GateWay 是Spring Cloud的一个全新项目，目标是取代<strong>Netflix Zuul</strong>，性能高于Zuul，官方测试，GateWay是Zuul的1.6倍，旨在为微服务架构提供一种简 单有效的统一的API路由管理方式。</p>
<p><strong>网关在架构中的位置</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ZLKkq"><img src="https://z3.ax1x.com/2021/09/15/4ZLKkq.png" alt="4ZLKkq.png"></a></p>
<p><strong>核心概念</strong></p>
<p>Spring Cloud GateWay天生就是异步非阻塞的，基于Reactor模型（同步非阻塞的I/O多路复用机 制） </p>
<p>一个请求—&gt;网关根据一定的条件匹配—匹配成功之后可以将请求转发到指定的服务地址；而在这 个过程中，我们可以进行一些比较具体的控制（限流、日志、黑白名单）</p>
<ul>
<li>路由（route）： 网关最基础的部分，也是网关比较基础的工作单元。路由由一个ID、一个目标 URL（最终路由到的地址）、一系列的断言（匹配条件判断）和Filter过滤器（精细化控制）组成。 如果断言为true，则匹配该路由。 </li>
<li>断言（predicates）：参考了Java8中的断言java.util.function.Predicate，开发人员可以匹配Http 请求中的所有内容（包括请求头、请求参数等）（类似于nginx中的location匹配一样），如果断言 与请求相匹配则路由。 </li>
<li>过滤器（filter）：一个标准的Spring webFilter，使用过滤器，可以在请求之前或者之后执行业务 逻辑。</li>
</ul>
<p><strong>GateWay工作流程</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ZLQhV"><img src="https://z3.ax1x.com/2021/09/15/4ZLQhV.png" alt="4ZLQhV.png"></a></p>
<h3 id="GateWay的使用"><a href="#GateWay的使用" class="headerlink" title="GateWay的使用"></a>GateWay的使用</h3><p>网关对静态化微服务进行代理，添加在静态化微服务的上游，相当于隐藏了具体微服务的信息，对外暴露的 是网关。</p>
<p><strong>创建工程lagou-cloud-gateway-server导入依赖</strong></p>
<p>GateWay不需要使用web模块，它引入的是WebFlux（类似于SpringMVC），所以这里不继承spirng-parent项目</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring boot 父启动器依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--GateWay 网关--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入webflux--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日志依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--测试依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok工具--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入Jaxb，开始--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10-b140310.1920<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入Jaxb，结束--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Actuator可以帮助你监控和管理Spring Boot应用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--链路追踪--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring cloud依赖版本管理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--编译插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--打包插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>application.yml 配置文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9301</span></span><br><span class="line"><span class="comment"># 注册中心配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># Eureka Server 地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://EurekaServerA:9201/eureka/,http://EurekaServerB:9202/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;:@project.version@</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-gateway</span></span><br><span class="line">  <span class="comment"># 网关配置</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-page-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://127.0.0.1:9101</span></span><br><span class="line">          <span class="attr">predicates:</span>  <span class="comment">#当断言成功后，交给某一个微服务处理时使用的是转发</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/page/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://127.0.0.1:9001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/product/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment">#去掉uri中的第一部分</span></span><br><span class="line">            <span class="comment"># 所以就要求我们通过网关访问的时候，把uri的第一部分设置为product，从uri的第二部分开始才是真正的uri</span></span><br></pre></td></tr></table></figure>
<p><strong>启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// 注册到注册中心</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GateWayApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GateWayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9301/page/queryById/1">http://127.0.0.1:9301/page/queryById/1</a> </p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9301/product/product/get/1">http://127.0.0.1:9301/product/product/get/1</a>   需多加上product，因为过滤器会去掉uri的第一部分</p>
<h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><p>Spring Cloud GateWay 帮我们内置了很多 Predicates功能，实现了各种路由匹配规则（通过 Header、请求参数等作为条件）匹配到对应的路由。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ZXiQS"><img src="https://z3.ax1x.com/2021/09/15/4ZXiQS.png" alt="4ZXiQS.png"></a></p>
<p><strong>时间点后的匹配</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">gateway:</span></span><br><span class="line">            <span class="attr">routes:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after_route</span></span><br><span class="line">                <span class="attr">uri:</span> <span class="string">http://127.0.0.1:9001</span></span><br><span class="line">                <span class="attr">predicates:</span></span><br><span class="line">                	<span class="bullet">-</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p><strong>时间点前匹配</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Before&#x3D;2017-01-20T17:42:47.789-07:00[America&#x2F;Denver]</span><br></pre></td></tr></table></figure>
<p><strong>时间区间匹配</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Between&#x3D;2017-01-20T17:42:47.789-07:00[America&#x2F;Denver], 2017-01-21T17:42:47.789-07:00[America&#x2F;Denver]</span><br></pre></td></tr></table></figure>
<p><strong>指定Cookie正则匹配指定值</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Cookie&#x3D;chocolate, ch.p</span><br></pre></td></tr></table></figure>
<p><strong>指定Header正则匹配指定值</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Header&#x3D;X-Request-Id, \d+</span><br></pre></td></tr></table></figure>
<p><strong>请求Host匹配指定值</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Host&#x3D;**.somehost.org,**.anotherhost.org</span><br></pre></td></tr></table></figure>
<p><strong>请求Method匹配指定请求方式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">	- Method&#x3D;GET,POST</span><br></pre></td></tr></table></figure>
<p><strong>请求路径正则匹配(最常用)</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Path=/red/&#123;segment&#125;,/blue/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>请求包含某参数</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Query=green</span></span><br><span class="line">	<span class="comment"># 请求包含某参数并且参数值匹配正则表达式</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Query=red,</span> <span class="string">gree.</span></span><br></pre></td></tr></table></figure>
<p><strong>远程地址匹配</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure>
<h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><p>GateWay支持自动从注册中心中获取服务列表并访问，即所谓的动态路由</p>
<ol>
<li>pom.xml中添加注册中心客户端依赖，并编写Eureka配置（上面已引入依赖并配置了Eureka）</li>
<li>动态路由配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-gateway</span></span><br><span class="line">  <span class="comment"># 网关配置</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-page-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://spring-service-page</span>  <span class="comment"># 动态路由,lb://注册中心中服务器名称</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/page/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://spring-service-product</span> <span class="comment"># 动态路由</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/product/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：动态路由设置时，uri以 lb: //开头（lb代表从注册中心获取服务），后面是需要转发到的服务名 称</p>
<h3 id="GateWay过滤器"><a href="#GateWay过滤器" class="headerlink" title="GateWay过滤器"></a>GateWay过滤器</h3><p>从过滤器生命周期（影响时机点）的角度来说，主要有两个pre和post</p>
<ul>
<li>pre  ： 这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选 择 请求的微服务、记录调试信息等。 </li>
<li>post  :  这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的 HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等</li>
</ul>
<p>从过滤器类型的角度，Spring Cloud GateWay的过滤器分为GateWayFilter和GlobalFilter两种</p>
<ul>
<li>GateWayFilter     <ul>
<li>应用到单个路由路由上，如配置文件中的filters</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/product/**</span></span><br><span class="line"><span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="comment"># 可以去掉product之后转发</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>GlobalFilter          <ul>
<li>应用到所有的路由上，需要实现 GlobalFilter接口，重写filter方法</li>
<li>也可以实现Ordered接口，重写getOrder方法，定义过滤器的优先级</li>
</ul>
</li>
</ul>
<p><strong>案例: 自定义全局过滤器实现IP访问限制（黑白名单）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackListFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟黑名单（实际可以去数据库或者redis中查询）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; blackList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        blackList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        blackList.add(<span class="string">&quot;0:0:0:0:0:0:0:1&quot;</span>); <span class="comment">// 模拟本机地址</span></span><br><span class="line">        blackList.add(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器核心方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 封装了request和response对象的上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain    网关过滤器链（包含全局过滤器和单路由过滤器）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        <span class="comment">// 从 request 中获取用户的主机地址</span></span><br><span class="line">        String host = request.getRemoteAddress().getHostString();</span><br><span class="line">        <span class="comment">// 如果在黑名单内，就直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (blackList.contains(host)) &#123;</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED); <span class="comment">// 设置返回状态码:401</span></span><br><span class="line">            String data = <span class="string">&quot;Request be denied&quot;</span>;</span><br><span class="line">            <span class="comment">// 将提示写出去，具体API用法不是很懂。。。</span></span><br><span class="line">            DataBuffer wrap = response.bufferFactory().wrap(data.getBytes());</span><br><span class="line">            <span class="keyword">return</span> response.writeWith(Mono.just(wrap));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  返回值表示当前过滤器的顺序(优先级)，数值越小，优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="GateWay高可用"><a href="#GateWay高可用" class="headerlink" title="GateWay高可用"></a>GateWay高可用</h3><p>网关作为非常核心的一个部件，如果挂掉，那么所有请求都可能无法路由处理，因此我们需要做 GateWay的高可用。 </p>
<p>启动多个GateWay实例来实现高可用，在GateWay的上游使用 <strong>Nginx</strong>等负载均衡设备进行负载转发以达到高可用的目的。 </p>
<p><strong>Nginx配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">配置多个GateWay实例</span></span><br><span class="line">upstream gateway &#123;</span><br><span class="line">    server 127.0.0.1:9301; # GateWay实例1</span><br><span class="line">    server 127.0.0.1:9302; # GateWay实例2</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen   80;</span><br><span class="line">    server_name  xxxxx; #当前访问的域名</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://exi; # 反向代理+负载均衡</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h2 id="Spring-Cloud-Config-分布式配置中心"><a href="#Spring-Cloud-Config-分布式配置中心" class="headerlink" title="Spring Cloud Config 分布式配置中心"></a>Spring Cloud Config 分布式配置中心</h2><p><strong>单体应用架构</strong>，配置信息的管理、维护并不会显得特别麻烦，手动操作就可以，因为就一个工程；</p>
<p><strong>微服务架构</strong>，分布式集群环境中可能有很多个微服务，我们不可能一个一个去修改配置 然后重启生效，在一定场景下我们还需要在运行期间动态调整配置信息，比如：根据各个微服务的负载 情况，动态调整数据源连接池大小，我们希望配置内容发生变化的时候，微服务可以自动更新</p>
<p><strong>分布式配置中心应用场景</strong></p>
<ol>
<li>集中配置管理，一个微服务架构中可能有成百上千个微服务，所以集中配置管理是很重要的 （一次修改、到处生效）</li>
<li>不同环境不同配置，比如数据源配置在不同环境（开发dev,测试test,生产prod）中是不同的</li>
<li>运行期间可动态调整。例如，可根据各个微服务的负载情况，动态调整数据源连接池大小等配 置修改后可自动更新</li>
</ol>
<h3 id="搭建分布式配置中心"><a href="#搭建分布式配置中心" class="headerlink" title="搭建分布式配置中心"></a>搭建分布式配置中心</h3><p>Spring Cloud Config是一个分布式配置管理方案，包含了 Server端和 Client端两个部分</p>
<ul>
<li>Server 端：提供配置文件的存储、以接口的形式将配置文件的内容提供出去，启动类中使用 @EnableConfigServer注解</li>
<li>Client 端：通过接口获取配置数据并初始化自己的应用</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eDJb9"><img src="https://z3.ax1x.com/2021/09/16/4eDJb9.png" alt="4eDJb9.png"></a></p>
<p><strong>前提准备</strong></p>
<ol>
<li><p>登录GitHub，创建项目hui-config</p>
</li>
<li><p>上传yml配置文件，命名规则如下： </p>
<p>{application}-{profile}.yml 或者 {application}-{profile}.properties 。其中，application为应用名称，profile指的是环境（用于区分开发环境，测试环境、生产环境 等） </p>
<p>示例：spring-service-page-dev.yml、spring-service-page-test.yml</p>
</li>
</ol>
<h4 id="构建Server服务端"><a href="#构建Server服务端" class="headerlink" title="构建Server服务端"></a>构建Server服务端</h4><p><strong>新建spring-cloud-config工程，引入依赖坐标（需要注册到Eureka）</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client 客户端依赖引入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--config配置中心服务端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// 注册中心</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span>  <span class="comment">// 开启配置服务器功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>application.yml配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9400</span></span><br><span class="line"><span class="comment"># 注册中心配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://EurekaServerA:9201/eureka/,http://EurekaServerB:9202/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;:@project.version@</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spirng-cloud-config</span></span><br><span class="line">  <span class="comment"># config配置</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/oddDog-git/hui-config.git</span> <span class="comment"># 配置git服务https地址</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">oddDog-git</span>   <span class="comment"># git用户名</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">*****</span> <span class="comment"># git密码</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">hui-config</span>   <span class="comment"># git中的哪一个项目</span></span><br><span class="line">      <span class="comment"># 读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<p>访问  <a target="_blank" rel="noopener" href="http://127.0.0.1/9400/master/application-dev.yml">http://127.0.0.1/9400/master/application-dev.yml</a>  ,只需指定分支名与文件名称</p>
<h4 id="构建Client客户端"><a href="#构建Client客户端" class="headerlink" title="构建Client客户端"></a>构建Client客户端</h4><p>需求：在spring-service-page微服务中动态获取config server的配置信息</p>
<p><strong>依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>配置application.yml并修改为bootstrap.yml配置文件</strong></p>
<p>bootstrap.yml是系统级别的，优先级比application.yml高，应用启动时会检查这个配置文件， 在这个配置文件中指定配置中心的服务地址，会自动拉取所有应用配置并且启用。 （主要是把与统一配置中心连接的配置信息放到bootstrap.yml） </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#config客户端配置,和ConfigServer</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">application</span>  <span class="comment"># 文件名</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>       <span class="comment"># 后缀名</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://127.0.0.1:9400</span>  <span class="comment">#ConfigServer配置中心地址  </span></span><br></pre></td></tr></table></figure>
<p><strong>创建Controller获取配置信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;mysql.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;mysql.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;configInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">configInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;username:&quot;</span> + username + <span class="string">&quot;,password:&quot;</span> + password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动测试： <a target="_blank" rel="noopener" href="http://127.0.0.1:9101/config/configInfo">http://127.0.0.1:9101/config/configInfo</a></p>
<h3 id="config配置手动刷新"><a href="#config配置手动刷新" class="headerlink" title="config配置手动刷新"></a>config配置手动刷新</h3><p>客户端取到了配置中心的值，但当我们修改GitHub上面的值时，服务端（Config Server）能 实时获取最新的值，但客户端（Config Client）读的是缓存，无法实时获取最新值。我们可以让客户端使用post去触发refresh，获取最新数据。</p>
<p><strong>添加springboot-starter-actuator依赖（父工程中已添加）</strong></p>
<p><strong>bootstrap.yml中添加配置（暴露通信端点）</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># springboot中暴露健康检查等断点接口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">refresh</span>  <span class="comment"># &quot;*&quot;表示暴露所有端口</span></span><br></pre></td></tr></table></figure>
<p><strong>在客户端使用到配置信息的类上添加@RefreshScope注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/config&quot;)</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//手动刷新</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123; <span class="comment">/*省略*/</span>&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<p>启动所有服务，修改git上的值，手动向Client客户端发起POST请求:</p>
<p><a target="_blank" rel="noopener" href="http://localhost:9100/actuator/refresh%EF%BC%8C%E5%88%B7%E6%96%B0%E5%8D%95%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">http://localhost:9100/actuator/refresh，刷新单个配置信息</a> (需使用postman测试)</p>
<h3 id="config配置自动刷新"><a href="#config配置自动刷新" class="headerlink" title="config配置自动刷新"></a>config配置自动刷新</h3><p>在微服务架构中，我们可以结合消息总线（Bus）实现分布式配置的自动更新（Spring Cloud Config + Spring Cloud Bus）</p>
<p><strong>消息总线Bus</strong></p>
<p>基于MQ的，支持RabbitMq/Kafka。即MQ消息代理构建一个共用的Topic，通过这个Topic连接各个微服务实例，MQ广播的消息会被所有在注册中心的微服务实例监听和消费。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4esD7d"><img src="https://z3.ax1x.com/2021/09/16/4esD7d.png" alt="4esD7d.png"></a></p>
<p>这里选择使用rabbitMq，ConfigServer和ConfigClient都添加消息总线的支持 以及与RabbitMq的连接信息</p>
<p><strong>前提准备</strong></p>
<p>在Linux服务器上安装并开启RabbitMq，通过   <strong><a target="_blank" rel="noopener" href="http://ip地址:15672/">http://ip地址:15672/</a></strong>     访问是否开启成功</p>
<p><strong>Config 服务端和客户端添加消息总线支持</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>服务端和客户端都添加RabbiMq配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RabbitMq</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">ip地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>
<p><strong>Config Server微服务暴露端口</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># springboot中暴露健康检查等断点接口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">bus-refresh</span>   <span class="comment"># &quot;*&quot;表示暴露所有端口</span></span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<p>重启各个服务，修改git上的值后，向配置中心服务端发送POST请求:</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9400/actuator/bus-refresh">http://127.0.0.1:9400/actuator/bus-refresh</a>  ，所有客户端中的配置都会刷新</p>
<p>如果只想刷新单个客户端，则访问</p>
<p><a target="_blank" rel="noopener" href="http://localhost:9400/actuator/bus-refresh/spring-service-page:9101">http://localhost:9400/actuator/bus-refresh/spring-service-page:9101</a> ，加上 <strong>服务名:端口号</strong> 即可</p>
<h1 id="第二代核心组件SCA"><a href="#第二代核心组件SCA" class="headerlink" title="第二代核心组件SCA"></a>第二代核心组件SCA</h1><p>Spring Cloud第一代核心组件主要以Netflix开源为主，而第二代核心组件Spring Cloud Alibaba 也是一套微服务解决方案，包含开发分布式应用微服 务的必需组件。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eyGDg"><img src="https://z3.ax1x.com/2021/09/16/4eyGDg.png" alt="4eyGDg.png"></a></p>
<p><strong>阿里开源组件</strong> </p>
<ul>
<li>Nacos：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。 </li>
<li>Sentinel：把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。 </li>
<li>RocketMQ：开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布 与订阅服务。 </li>
<li>Dubbo：这个就不用多说了，在国内应用非常广泛的一款高性能 Java RPC 框架。 </li>
<li>Seata：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。 </li>
<li>Arthas：开源的Java动态追踪工具，基于字节码增强技术，功能非常强大。</li>
</ul>
<p>Spring Cloud Alibaba 作为整套的微服务解决组件，只依靠目前阿里的开源组件是不够的，更多的是集 成当前的社区组件，所以 Spring Cloud Alibaba 可以集成 Zuul，GateWay等网关组件，也可继承 Ribbon、OpenFeign等组件。</p>
<h2 id="Nacos服务支持和配置中心"><a href="#Nacos服务支持和配置中心" class="headerlink" title="Nacos服务支持和配置中心"></a>Nacos服务支持和配置中心</h2><p>Nacos （Dynamic Naming and Configuration Service）是阿里巴巴开源的一个针对微服务架构中 服务发现、配置管理和服务管理平台。</p>
<p>Nacos就是注册中心+配置中心的组合（<strong>Nacos=Eureka + Config + Bus</strong>）</p>
<p><strong>Nacos功能</strong></p>
<ul>
<li>服务发现与健康检查 </li>
<li>动态配置管理 </li>
<li>动态DNS服务 </li>
<li>服务和元数据管理<ul>
<li>nacos也一个ui页面，可以看到注册的服务及其实例信息 （元数据信息）、动态的服务权重调整、动态服务优雅下线</li>
</ul>
</li>
</ul>
<h3 id="Nacos单例服务器部署"><a href="#Nacos单例服务器部署" class="headerlink" title="Nacos单例服务器部署"></a>Nacos单例服务器部署</h3><p><strong>下载并解压Nacos安装包，执行命令启动</strong></p>
<p>这里使用最近比较稳定的版本 nacos-server-1.2.0.tar.gz</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linux&#x2F;mac：sh startup.sh -m standalone</span><br><span class="line">windows：cmd startup.cmd  &#x2F;&#x2F; 直接双击也行</span><br></pre></td></tr></table></figure>
<p>访问nacos控制台：<a target="_blank" rel="noopener" href="http://127.0.0.1:8848/nacos/#/login">http://127.0.0.1:8848/nacos/#/login</a> 或者 <a target="_blank" rel="noopener" href="http://127.0.0.1:8848/nacos/index.html%EF%BC%88%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A38848%EF%BC%8C%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81">http://127.0.0.1:8848/nacos/index.html（默认端口8848，账号和密码</a> nacos/nacos）</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4e6ER0"><img src="https://z3.ax1x.com/2021/09/16/4e6ER0.png" alt="4e6ER0.png"></a></p>
<h3 id="微服务注册到Nacos"><a href="#微服务注册到Nacos" class="headerlink" title="微服务注册到Nacos"></a>微服务注册到Nacos</h3><p><strong>在父pom中引入SCA依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SCA --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>在商品服务提供者工程中引入nacos客户端依赖，必须去除eureka-client依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>**修改application.yml，添加nacos配置信息 **</p>
<p>在yml文件中需要删除调用config和eureka相关的配置，否则启动失败</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>  <span class="comment">#nacos server 地址</span></span><br></pre></td></tr></table></figure>
<p><strong>启动商品微服务，观察Nacos控制台</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ec74A"><img src="https://z3.ax1x.com/2021/09/16/4ec74A.png" alt="4ec74A.png"></a></p>
<p><strong>保护阈值</strong>：可以设置为0-1之间的浮点数，它其实是一个比例值</p>
<p>当一个集群中  健康实例数/总实例数 &lt; 保护阈值 时，保护阈值 会被触发（状态true）</p>
<p>nacos将会把该服务所有的实例信息（健康的+不健康的）全部提供给消费者，消费者可能访问到不 健康的实例，请求失败，但这样也比造成雪崩要好，牺牲了一些请求，保证了整个系统的一个可用。</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>Nacos客户端引入的时候，会关联引入Ribbon的依赖包，Ribbon与Hystrix都按原来方式进行配置即可</p>
<p>之前使用OpenFeign与Eureka时都会自动引入Ribbon依赖。</p>
<h3 id="Nacos-数据模型（领域模型）"><a href="#Nacos-数据模型（领域模型）" class="headerlink" title="Nacos 数据模型（领域模型）"></a>Nacos 数据模型（领域模型）</h3><p>Nacos抽象出了Namespace、Group、Service、DataId等概念，具体代表什么取决于怎么用（非 常灵活），推荐用法如下</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Namespace</td>
<td>代表不同的环境，如开发dev、测试test、生产环境prod</td>
</tr>
<tr>
<td>Group</td>
<td>代表某项目，比如拉勾云项目</td>
</tr>
<tr>
<td>Service</td>
<td>某个项目中具体xxx服务</td>
</tr>
<tr>
<td>DataId</td>
<td>某个项目中具体的xxx配置文件</td>
</tr>
</tbody></table>
<p><strong>Namespace + Group + Service  是为 了锁定服务</strong> </p>
<p><strong>Namespace + Group + DataId  是为 了锁定配置文件</strong></p>
<p>Namespace命名空间、Group分组、集群这些都是为了进行归类管理，把服务和配置文件进行归 类，归类之后就可以实现一定的效果，比如隔离</p>
<h3 id="Nacos配置中心"><a href="#Nacos配置中心" class="headerlink" title="Nacos配置中心"></a>Nacos配置中心</h3><p>之前使用 Spring Cloud Config + Bus ，需要用到GitHub与RabbitMq，比较繁琐</p>
<p>而Nacos分布式配置就比较的简单，只需在Nacos控制台中添加配置信息，微服务项目添加一些配置就直接就可获取</p>
<h4 id="Nacos-Server添加配置"><a href="#Nacos-Server添加配置" class="headerlink" title="Nacos Server添加配置"></a>Nacos Server添加配置</h4><p>可以创建不用环境下的命名空间，如dev、test、prod</p>
<p>在控制台配置管理中的配置列表选择命名空间，默认public，选择添加配置信息按钮</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ecTNd"><img src="https://z3.ax1x.com/2021/09/16/4ecTNd.png" alt="4ecTNd.png"></a></p>
<h4 id="微服务中获取Nacos配置信息"><a href="#微服务中获取Nacos配置信息" class="headerlink" title="微服务中获取Nacos配置信息"></a>微服务中获取Nacos配置信息</h4><p><strong>添加依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>微服务中如何锁定 Nacos Server 中的配置文件（dataId）</strong></p>
<p>通过 Namespace + Group + dataId 来锁定配置文件，Namespace不指定就默认public，Group不 指定就默认 DEFAULT_GROUP</p>
<p><strong>dataId 的完整格式如下</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;prefix&#125;-$&#123;spring.profile.active&#125;.$&#123;file-extension&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>prefix 默认为 spring.application.name 的值，也可以通过配置项 spring.cloud.nacos.config.prefix 来配置。 </li>
<li>spring.profile.active 即为当前环境对应的 profile。 <ul>
<li>当 spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}</li>
</ul>
</li>
<li>file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类 型。</li>
</ul>
<p><strong>添加配置，配置文件需要修改成bootstrap.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-service-page</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>  <span class="comment">#nacos server 地址</span></span><br><span class="line">      <span class="comment"># 获取nacos配置</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>  <span class="comment">#nacos server 地址</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">81015dac-73a9-4d39-8fb1-74230a8c46cc</span>  <span class="comment">#命名空间的ID</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span>   <span class="comment"># 如果使用的默认分组,可以不设置</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>  <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="comment"># 获取当前命名空间的其他配置文件</span></span><br><span class="line">        <span class="string">ext-config[0]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">pageA.yaml</span>  <span class="comment"># dataId</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># 组</span></span><br><span class="line">          <span class="attr">refresh:</span> <span class="literal">true</span>        <span class="comment"># 是否自动刷新</span></span><br><span class="line">        <span class="string">ext-config[1]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">pageB.yaml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">          <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>在Controller中测试获取远程配置</strong></p>
<p>原生注解 @RefreshScope 实现配置自动更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;config&quot;)</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//手动刷新</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 从nacos的配置中获取</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;message.text&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pageA&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pageA;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pageB&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pageB;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;query&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> text+<span class="string">&quot;--&quot;</span>+pageA+<span class="string">&quot;--&quot;</span>+pageB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Sentinel分布式系统流量的防卫兵"><a href="#Sentinel分布式系统流量的防卫兵" class="headerlink" title="Sentinel分布式系统流量的防卫兵"></a>Sentinel分布式系统流量的防卫兵</h2><p>Sentinel是一个面向云原生微服务的流量控制、熔断降级组件。 替代Hystrix。</p>
<p>解决问题：服务雪崩、服务降级、服务熔断、服务限流</p>
<p><strong>Hystrix</strong>   没有控制台，只能使用@HystrixCommand来配置熔断，严重的代码入侵</p>
<p><strong>Sentinel</strong>  独立部署Dashboard/控制台组件，直接通过UI界面动态完成细粒度控制</p>
<p>Sentinel 分为两个部分: </p>
<ul>
<li>核心库：（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。 </li>
<li>控制台：（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等 应用容器。</li>
</ul>
<p>Sentinel 的主要特性：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ehKcn"><img src="https://z3.ax1x.com/2021/09/16/4ehKcn.png" alt="4ehKcn.png"></a></p>
<h3 id="部署Sentinel"><a href="#部署Sentinel" class="headerlink" title="部署Sentinel"></a>部署Sentinel</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a> 这里使用版本:v1.7.1 </p>
<p>启动：java -jar sentinel-dashboard-1.7.1.jar    </p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> , 用户名/密码：sentinel/sentinel</p>
<h3 id="改造微服务项目"><a href="#改造微服务项目" class="headerlink" title="改造微服务项目"></a>改造微服务项目</h3><p>“静态化微服务”调用了“商品微服务”，在静态化微服务进行的熔断降级等控制，这里改造静态化微服务</p>
<p><strong>引入Sentinel核心包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>修改application.yml</strong></p>
<p>删除原有hystrix配置，删除 原有OpenFeign的降级配置,依然需要暴露断电</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#解决bean重复注册问题</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment"># sentinel配置</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span> <span class="comment"># 指定sentinel控制台的地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span>  <span class="comment"># 在微服务启动时会启动一个Http Server,该Server的作用是与sentinel的dashboard经行交互 push</span></span><br><span class="line"><span class="comment"># springboot中暴露健康检查等断点接口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="comment"># 暴露健康接口的细节</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span> </span><br></pre></td></tr></table></figure>
<p><strong>启动静态化微服务</strong></p>
<p>控制台没有任何变化，因为懒加载，只需要随机发起一次请求触发即可</p>
<h3 id="Sentinel流量规则"><a href="#Sentinel流量规则" class="headerlink" title="Sentinel流量规则"></a>Sentinel流量规则</h3><p> <strong>Sentinel 关键概念</strong></p>
<ul>
<li>资源<ul>
<li>它可以是 Java 应用程序中的任何内容，我们请求的API接口就是资源</li>
</ul>
</li>
<li>规则<ul>
<li>围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规 则。所有规则可以动态实时调整。</li>
</ul>
</li>
</ul>
<p>系统并发能力有限，比如系统A的QPS支持1个，如果太多请求过来，那么A就应该进行流量控制 了，比如直接拒绝其他请求</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eo0Re"><img src="https://z3.ax1x.com/2021/09/16/4eo0Re.png" alt="4eo0Re.png"></a></p>
<ul>
<li><p>资源名：默认请求路径 </p>
</li>
<li><p>针对来源：Sentinel可以针对调用者进行限流，填写微服务名称，默认default（不区分来源） </p>
</li>
<li><p>阈值类型/单机阈值 </p>
<ul>
<li>QPS：（每秒钟请求数量）当调用该资源的QPS达到阈值时进行限流</li>
<li>线程数：当调用该资源的线程数达到阈值的时候进行限流 </li>
</ul>
</li>
<li><p>是否集群：是否集群限流 </p>
</li>
<li><p>流控模式： </p>
<ul>
<li>直接：资源调用达到限流条件时，直接限流 </li>
<li>关联：关联的资源调用达到阈值时候限流自己 </li>
<li>链路：只记录指定链路上的流量 </li>
</ul>
</li>
<li><p>流控效果： </p>
<ul>
<li>快速失败：直接失败，抛出异常 </li>
<li>Warm Up：根据冷加载因子（默认3）的值，从阈值/冷加载因子，经过预热时长，才达到设置的 QPS阈值 </li>
<li>排队等待：匀速排队，让请求匀速通过，阈值类型必须设置为QPS，否则无效 </li>
</ul>
</li>
</ul>
<h4 id="流控模式之关联限流"><a href="#流控模式之关联限流" class="headerlink" title="流控模式之关联限流"></a>流控模式之关联限流</h4><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eT1Ff"><img src="https://z3.ax1x.com/2021/09/16/4eT1Ff.png" alt="4eT1Ff.png" style="zoom:67%;" /></a></p>
<p>比如用户注册接口，需要调用手机短信校验接口，如果手机短信校验接口请求达到阈值，使用关联，可以对用户注册接口进行限流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟注册，注册时要调用手机短信验证，如果手机短信验证出问题了，就应该对注册功能限流，防止雪崩</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;registry&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">registry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;注册&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟获取手机短信功能</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;phoneVerify&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">phoneVerify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;短信验证&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用Postman对手机短信接口密集式请求，会发现用户注册接口被限流</p>
<h4 id="流控模式之链路限流"><a href="#流控模式之链路限流" class="headerlink" title="流控模式之链路限流"></a>流控模式之链路限流</h4><p>链路指的是请求链路（调用链：A–&gt;C，B–&gt;C） </p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eHcZR"><img src="https://z3.ax1x.com/2021/09/16/4eHcZR.png" alt="4eHcZR.png" style="zoom: 67%;" /></a></p>
<p>上图中来自入口 A 和 B  的请求都调用到了资源 C ，Sentinel 允许只根据某个 调用入口的统计信息对资源限流。比如链路模式下设置入口资源为 A ,表示只有从入口 A 的调用才会记录到 C 的限流统计当中，而不关心经 B 人口 到来的调用</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4ebJSO"><img src="https://z3.ax1x.com/2021/09/16/4ebJSO.png" alt="4ebJSO.png" style="zoom: 67%;" /></a></p>
<h4 id="流控效果之Warm-up"><a href="#流控效果之Warm-up" class="headerlink" title="流控效果之Warm up"></a>流控效果之Warm up</h4><p>通过 Warm Up 模式（预热模式），让通过的流量缓慢增加，经过设置的<strong>预热时间</strong>以后，到达系统 处理请求速率的设定值。 </p>
<p>Warm Up 模式默认会从设置的 QPS 阈值的 1/3 开始慢慢往上增加至 QPS 设置值。</p>
<p>例如：预热时间为10s, QPS值为10，系统刚启动，在10秒内QPS值会从 10*（1/3） 变成 10，防止瞬间把系统压垮</p>
<h4 id="流控效果之排队等待"><a href="#流控效果之排队等待" class="headerlink" title="流控效果之排队等待"></a>流控效果之排队等待</h4><p>很多流量过来并超过阈值，并不是直接拒绝请求，而是请求进行排队，一个一个匀速通过（处理），请求能 等就等着被处理，如果  等待时间&gt;超时时间 ，就会被拒绝 </p>
<p>例如，QPS 配置为 5，则代表请求每 200 ms 才能通过一个，多出的请求将排队等待通过。超时时 间代表最大排队时间，超出最大排队时间的请求将会直接被拒绝。排队等待模式下，QPS 设置值不要超 过 1000（请求间隔 1 ms）。</p>
<h3 id="Sentinel降级规则"><a href="#Sentinel降级规则" class="headerlink" title="Sentinel降级规则"></a>Sentinel降级规则</h3><p>流控是对外部来的大流量进行控制，熔断降级的视角是对内部问题进行处理。</p>
<p>Sentinel 降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这 个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。</p>
<p>当资源被降级后， 在接下来的降级时间窗口之内，对该资源的调用都自动熔断，这里的降级其实是<strong>Hystrix中的熔断</strong>。</p>
<p>Sentinel不会像Hystrix那样放过一个请求尝试自我修复，而是明确按照时间窗口来，熔断触发 后，时间窗口内拒绝请求，时间窗口后就恢复。</p>
<h4 id="RT（平均响应时间-）"><a href="#RT（平均响应时间-）" class="headerlink" title="RT（平均响应时间 ）"></a>RT（平均响应时间 ）</h4><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/4eXkB4"><img src="https://z3.ax1x.com/2021/09/16/4eXkB4.png" alt="4eXkB4.png"></a></p>
<p>降级后会对该方法的调用都会自动地熔断（抛出 DegradeException）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可 以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。</p>
<h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><p>异常比率的阈值范围是 [0.0, 1.0] ，代表 0% - 100%</p>
<p>在1s中请求发生异常的比例超过阈值时，资源进入降级状态</p>
<h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><p>当资源近 1 分钟的异常数目超过阈值之后会进行熔断。</p>
<p>注意由于统计时间窗口是分钟级别的，若 时间窗口小于 60s，则结束熔断状态后仍可能再进入熔断状态，所以设置 时间窗口 &gt;= 60s。</p>
<h2 id="SCA-小结"><a href="#SCA-小结" class="headerlink" title="SCA 小结"></a>SCA 小结</h2><p>SCA实际上发展了三条线 </p>
<ul>
<li>第一条线：开源出来一些组件 </li>
<li>第二条线：阿里内部维护了一个分支，自己业务线使用 </li>
<li>第三条线：阿里云平台部署一套，付费使用 </li>
</ul>
<p>从战略上来说，SCA更是为了贴合阿里云。 目前来看，开源出来的这些组件，推广及普及率不高，社区活跃度不高，稳定性和体验度上仍需进 一步提升，根据实际使用来看Sentinel的稳定性和体验度要好于Nacos。</p>
<p>over。。。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>感谢老铁们的支持!!!</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/weChatPay.png" alt="怪狗狗 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/aliPay.jpg" alt="怪狗狗 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringCloud/" rel="tag"> SpringCloud</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/09/SpringBoot/" rel="prev" title="SpringBoot">
      <i class="fa fa-chevron-left"></i> SpringBoot
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/21/ElasticSearch/" rel="next" title="ElasticSearch">
      ElasticSearch <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">微服务架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">SpringCloud介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E6%A1%88%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">准备案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">父工程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.2.</span> <span class="nav-text">公共组件微服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.3.</span> <span class="nav-text">商品微服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.4.</span> <span class="nav-text">页面静态微服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81%E9%97%AE%E9%A2%98"><span class="nav-number">3.5.</span> <span class="nav-text">案例代码问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%BB%A3%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6SCN"><span class="nav-number">4.</span> <span class="nav-text">第一代核心组件SCN</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.</span> <span class="nav-text">Eureka服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.1.1.</span> <span class="nav-text">服务注册中心相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.1.2.</span> <span class="nav-text">Eureka相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%8D%95%E4%BE%8BEureka-Server%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.3.</span> <span class="nav-text">搭建单例Eureka Server服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%8D%95%E4%BE%8BEureka-Server"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">搭建单例Eureka Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%B3%A8%E5%86%8C%E5%88%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">服务提供者注册到注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E6%B3%A8%E5%86%8C%E5%88%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">服务消费者注册到注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E8%B0%83%E7%94%A8"><span class="nav-number">4.1.3.4.</span> <span class="nav-text">完成调用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAEureka-Server-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="nav-number">4.1.4.</span> <span class="nav-text">搭建Eureka Server 高可用集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka%E7%BB%86%E8%8A%82%E8%AF%A6%E6%83%85"><span class="nav-number">4.1.5.</span> <span class="nav-text">Eureka细节详情</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">4.1.5.1.</span> <span class="nav-text">Eureka元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%A6%E6%83%85"><span class="nav-number">4.1.5.2.</span> <span class="nav-text">Eureka客户端详情</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%A6%E6%83%85"><span class="nav-number">4.1.5.3.</span> <span class="nav-text">Eureka服务端详情</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.2.</span> <span class="nav-text">Ribbon负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.2.1.</span> <span class="nav-text">负载均衡相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.2.2.</span> <span class="nav-text">Ribbon的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">4.2.3.</span> <span class="nav-text">Ribbon负载均衡策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">4.2.4.</span> <span class="nav-text">Ribbon源码剖析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-number">4.3.</span> <span class="nav-text">Hystrix熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.3.1.</span> <span class="nav-text">服务雪崩相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E7%AE%80%E4%BB%8B"><span class="nav-number">4.3.2.</span> <span class="nav-text">Hystrix简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.3.3.</span> <span class="nav-text">Hystrix的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%A4%84%E7%90%86"><span class="nav-number">4.3.3.1.</span> <span class="nav-text">熔断处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-number">4.3.3.2.</span> <span class="nav-text">服务降级</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E4%B8%8E%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="nav-number">4.3.4.</span> <span class="nav-text">Hystrix工作流程与高级应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="nav-number">4.4.</span> <span class="nav-text">Feign服务调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.4.1.</span> <span class="nav-text">Feign的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E5%AF%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">4.4.2.</span> <span class="nav-text">Feign对负载均衡的支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E5%AF%B9%E7%86%94%E6%96%AD%E5%99%A8%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">4.4.3.</span> <span class="nav-text">Feign对熔断器的支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E5%AF%B9%E8%AF%B7%E6%B1%82%E5%8E%8B%E7%BC%A9%E5%92%8C%E5%93%8D%E5%BA%94%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">4.4.4.</span> <span class="nav-text">Feign对请求压缩和响应压缩的支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway%E7%BD%91%E5%85%B3"><span class="nav-number">4.5.</span> <span class="nav-text">Gateway网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GateWay%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.5.1.</span> <span class="nav-text">GateWay相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GateWay%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.5.2.</span> <span class="nav-text">GateWay的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="nav-number">4.5.3.</span> <span class="nav-text">路由规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-number">4.5.4.</span> <span class="nav-text">动态路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GateWay%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">4.5.5.</span> <span class="nav-text">GateWay过滤器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GateWay%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.5.6.</span> <span class="nav-text">GateWay高可用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Cloud-Config-%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">4.6.</span> <span class="nav-text">Spring Cloud Config 分布式配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">4.6.1.</span> <span class="nav-text">搭建分布式配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BAServer%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">4.6.1.1.</span> <span class="nav-text">构建Server服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BAClient%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.6.1.2.</span> <span class="nav-text">构建Client客户端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config%E9%85%8D%E7%BD%AE%E6%89%8B%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="nav-number">4.6.2.</span> <span class="nav-text">config配置手动刷新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="nav-number">4.6.3.</span> <span class="nav-text">config配置自动刷新</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E4%BB%A3%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6SCA"><span class="nav-number">5.</span> <span class="nav-text">第二代核心组件SCA</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%9C%8D%E5%8A%A1%E6%94%AF%E6%8C%81%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">5.1.</span> <span class="nav-text">Nacos服务支持和配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos%E5%8D%95%E4%BE%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="nav-number">5.1.1.</span> <span class="nav-text">Nacos单例服务器部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0Nacos"><span class="nav-number">5.1.2.</span> <span class="nav-text">微服务注册到Nacos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">5.1.3.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%EF%BC%88%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B%EF%BC%89"><span class="nav-number">5.1.4.</span> <span class="nav-text">Nacos 数据模型（领域模型）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">5.1.5.</span> <span class="nav-text">Nacos配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos-Server%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">5.1.5.1.</span> <span class="nav-text">Nacos Server添加配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E8%8E%B7%E5%8F%96Nacos%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="nav-number">5.1.5.2.</span> <span class="nav-text">微服务中获取Nacos配置信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E6%B5%81%E9%87%8F%E7%9A%84%E9%98%B2%E5%8D%AB%E5%85%B5"><span class="nav-number">5.2.</span> <span class="nav-text">Sentinel分布式系统流量的防卫兵</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Sentinel"><span class="nav-number">5.2.1.</span> <span class="nav-text">部署Sentinel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E9%80%A0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE"><span class="nav-number">5.2.2.</span> <span class="nav-text">改造微服务项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sentinel%E6%B5%81%E9%87%8F%E8%A7%84%E5%88%99"><span class="nav-number">5.2.3.</span> <span class="nav-text">Sentinel流量规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%85%B3%E8%81%94%E9%99%90%E6%B5%81"><span class="nav-number">5.2.3.1.</span> <span class="nav-text">流控模式之关联限流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%93%BE%E8%B7%AF%E9%99%90%E6%B5%81"><span class="nav-number">5.2.3.2.</span> <span class="nav-text">流控模式之链路限流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%E4%B9%8BWarm-up"><span class="nav-number">5.2.3.3.</span> <span class="nav-text">流控效果之Warm up</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%E4%B9%8B%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="nav-number">5.2.3.4.</span> <span class="nav-text">流控效果之排队等待</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sentinel%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="nav-number">5.2.4.</span> <span class="nav-text">Sentinel降级规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RT%EF%BC%88%E5%B9%B3%E5%9D%87%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4-%EF%BC%89"><span class="nav-number">5.2.4.1.</span> <span class="nav-text">RT（平均响应时间 ）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="nav-number">5.2.4.2.</span> <span class="nav-text">异常比例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="nav-number">5.2.4.3.</span> <span class="nav-text">异常数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SCA-%E5%B0%8F%E7%BB%93"><span class="nav-number">5.3.</span> <span class="nav-text">SCA 小结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="怪狗狗"
      src="/images/jerry.jpg">
  <p class="site-author-name" itemprop="name">怪狗狗</p>
  <div class="site-description" itemprop="description">踏上新征程----go！！！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/oddDog-git" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oddDog-git" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://1764501567@qq.com/" title="E-Mail → https:&#x2F;&#x2F;1764501567@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://wpa.qq.com/msgrd?v=3&uin=1764501567&site=qq&menu=yes" title="http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;1764501567&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener" target="_blank">加我QQ</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">怪狗狗</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div> -->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'YVPmrsyUdC4uV9bapDgb8ll6-gzGzoHsz',
      appKey     : 'MUI57EQtRoMQjLvpW68kiNyE',
      placeholder: "快来评论吧！！！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
